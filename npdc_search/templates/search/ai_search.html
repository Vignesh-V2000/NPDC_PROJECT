{% extends "base.html" %}
{% load static %}

{% block title %}Penguin Search <small class="text-warning">alpha</small> ‚Äî National Polar Data Center{% endblock %}

{% block content %}
<div class="chat-app">
    <!-- Left Sidebar -->
    <aside class="chat-sidebar" id="chat-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <div class="sidebar-logo-icon">
                    üêß
                </div>
                <span class="sidebar-brand-text">Penguin <small class="text-warning">alpha</small></span>
            </div>
            <button class="sidebar-collapse-btn" id="sidebar-collapse-btn" onclick="toggleSidebarCollapse()"
                title="Collapse sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="6" />
                    <line x1="18" y1="12" x2="6" y2="12" />
                    <line x1="18" y1="18" x2="6" y2="18" />
                    <polyline points="9 18 3 12 9 6" />
                </svg>
            </button>
        </div>
        <div class="sidebar-new-chat">
            <button class="new-chat-btn" onclick="newChat()">
                <i class="fas fa-plus"></i>
                <span class="sidebar-show-text">New Chat</span>
            </button>
        </div>
        <div class="sidebar-search sidebar-show-text">
            <i class="fas fa-search" style="color:rgba(255,255,255,0.4)"></i>
            <input type="text" placeholder="Search" id="sidebar-search-input" oninput="filterHistory(this.value)">
        </div>
        <div class="sidebar-history" id="chat-history">
            <div class="history-empty">
                <i class="fas fa-comment-dots"></i>
                <p>Your search history will appear here</p>
            </div>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="chat-main">
        <!-- Toggle sidebar (mobile) -->
        <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebarMobile()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Fixed scroll navigation arrows -->
        <div class="scroll-nav" id="scroll-nav">
            <button class="scroll-nav-btn" id="scroll-up-btn" onclick="scrollNav('up')" title="Scroll up">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2.5">
                    <polyline points="18 15 12 9 6 15" />
                </svg>
            </button>
            <button class="scroll-nav-btn" id="scroll-down-btn" onclick="scrollNav('down')" title="Scroll down">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2.5">
                    <polyline points="6 9 12 15 18 9" />
                </svg>
            </button>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chat-messages">
            <!-- Welcome state -->
            <div class="welcome-state" id="welcome-state">

                <h2>üêß Penguin Search <small class="text-warning">alpha</small></h2>
                <p>Ask questions about India's polar and cryospheric research datasets</p>
                <div class="welcome-chips">
                    <button class="welcome-chip" onclick="askQuestion('What Antarctic ice sheet data is available?')">
                        <i class="fas fa-snowflake"></i> Antarctic ice sheet data
                    </button>
                    <button class="welcome-chip"
                        onclick="askQuestion('Ocean temperature datasets from Southern Ocean')">
                        <i class="fas fa-water"></i> Southern Ocean temperature
                    </button>
                    <button class="welcome-chip" onclick="askQuestion('Himalayan glacier research datasets')">
                        <i class="fas fa-mountain"></i> Himalayan glacier research
                    </button>
                    <button class="welcome-chip" onclick="askQuestion('Arctic expedition data from recent years')">
                        <i class="fas fa-globe-americas"></i> Arctic expedition data
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Input Bar -->
        <div class="chat-input-area">
            <div class="chat-input-wrapper">
                <div class="input-row">
                    <div class="input-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <input type="text" id="chat-input" class="chat-input" placeholder="What would you like to ask?"
                        autocomplete="off" maxlength="500"
                        onkeydown="if(event.key==='Enter'){event.preventDefault();sendMessage();}">
                    <button class="send-btn" id="send-btn" onclick="sendMessage()">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            <p class="disclaimer">
                The Penguin search service <strong>(alpha)</strong> provides answers based on indexed datasets. Results may not be exhaustive.
            </p>
        </div>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<style>
    /* Override base layout for full-screen chat */
    main.fade-in {
        padding: 0 !important;
    }

    main.fade-in>.container {
        max-width: 100% !important;
        padding: 0 !important;
    }

    /* ===== CHAT APP LAYOUT ===== */
    .chat-app {
        display: flex;
        height: calc(100vh - 70px);
        overflow: hidden;
        background: #0b1726;
    }

    /* ===== LEFT SIDEBAR ===== */
    .chat-sidebar {
        width: 260px;
        min-width: 260px;
        background: #0a1220;
        border-right: 1px solid rgba(255, 255, 255, 0.06);
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease;
        z-index: 20;
    }

    .sidebar-header {
        padding: 12px 16px 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .sidebar-brand {
        display: flex;
        align-items: center;
        gap: 8px;
        overflow: hidden;
    }

    .sidebar-logo-icon {
        width: 32px;
        height: 32px;
        min-width: 32px;
        background: linear-gradient(135deg, #004F87, #0088CC);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .sidebar-logo-icon i {
        color: white;
        font-size: 0.85rem;
    }

    .sidebar-brand-text {
        color: #FFFFFF;
        font-size: 1rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        white-space: nowrap;
        overflow: hidden;
    }

    .sidebar-collapse-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.4);
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: color 0.2s, background 0.2s;
    }

    .sidebar-collapse-btn:hover {
        color: rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.06);
    }

    .sidebar-new-chat {
        padding: 8px 16px 4px;
    }

    /* Collapsed state */
    .chat-sidebar.collapsed {
        width: 60px;
        min-width: 60px;
    }

    .chat-sidebar.collapsed .sidebar-brand-text,
    .chat-sidebar.collapsed .sidebar-show-text {
        display: none;
    }

    .chat-sidebar.collapsed .sidebar-collapse-btn svg polyline {
        /* flip arrow direction */
    }

    .chat-sidebar.collapsed .new-chat-btn {
        padding: 12px;
        justify-content: center;
        gap: 0;
    }

    .chat-sidebar.collapsed .sidebar-search {
        display: none;
    }

    .chat-sidebar.collapsed .sidebar-history {
        display: none;
    }

    .chat-sidebar.collapsed .history-group-label {
        display: none;
    }

    /* Scroll Navigation Arrows */
    .scroll-nav {
        position: absolute;
        right: 16px;
        bottom: 90px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        z-index: 10;
    }

    .scroll-nav-btn {
        width: 42px;
        height: 42px;
        background: rgba(20, 40, 65, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 50%;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        backdrop-filter: blur(8px);
    }

    .scroll-nav-btn:hover {
        background: rgba(0, 136, 204, 0.3);
        border-color: rgba(0, 136, 204, 0.5);
        color: #fff;
    }

    .new-chat-btn {
        width: 100%;
        display: flex;
        align-items: center;
        gap: 10px;
        background: #0088CC;
        color: white;
        border: none;
        border-radius: 10px;
        padding: 12px 18px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .new-chat-btn:hover {
        background: #006fa3;
    }

    .sidebar-search {
        padding: 0 16px 12px;
        position: relative;
    }

    .sidebar-search i {
        position: absolute;
        left: 28px;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255, 255, 255, 0.3);
        font-size: 0.8rem;
    }

    .sidebar-search input {
        width: 100%;
        background: rgba(255, 255, 255, 0.06) !important;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 9px 12px 9px 36px;
        color: rgba(255, 255, 255, 0.85) !important;
        -webkit-text-fill-color: rgba(255, 255, 255, 0.85);
        caret-color: #0088CC;
        font-size: 0.85rem;
        outline: none;
    }

    .sidebar-search input:focus {
        border-color: rgba(0, 136, 204, 0.5);
        background: rgba(255, 255, 255, 0.08);
    }

    .sidebar-search input::placeholder {
        color: rgba(255, 255, 255, 0.3);
    }

    .sidebar-history {
        flex: 1;
        overflow-y: auto;
        padding: 0 8px;
    }

    .history-empty {
        text-align: center;
        padding: 2rem 1rem;
        color: rgba(255, 255, 255, 0.25);
    }

    .history-empty i {
        font-size: 2rem;
        margin-bottom: 0.75rem;
        display: block;
    }

    .history-empty p {
        font-size: 0.8rem;
        line-height: 1.4;
    }

    .history-group-label {
        padding: 12px 12px 4px;
        font-size: 0.7rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .history-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.15s;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        position: relative;
    }

    .history-item:hover {
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.9);
    }

    .history-item.active-session {
        background: rgba(0, 136, 204, 0.15);
        color: rgba(255, 255, 255, 0.95);
        border-left: 3px solid #0088CC;
        padding-left: 9px;
    }

    .history-item.active-session i.fa-search {
        color: #0088CC;
    }

    .history-item i.fa-search {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.3);
        flex-shrink: 0;
    }

    .history-item span {
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }

    .history-delete-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.2);
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8rem;
        opacity: 0;
        transition: all 0.15s;
        flex-shrink: 0;
    }

    .history-item:hover .history-delete-btn {
        opacity: 1;
    }

    .history-delete-btn:hover {
        color: #e74c3c;
        background: rgba(231, 76, 60, 0.15);
    }

    /* Response time label */
    .response-time-label {
        padding-left: 42px;
        margin-top: 4px;
        color: rgba(255, 255, 255, 0.25);
        font-size: 0.72rem;
    }

    /* ===== MAIN CHAT AREA ===== */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        position: relative;
    }

    .sidebar-toggle {
        position: absolute;
        top: 12px;
        left: 12px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.6);
        padding: 8px 10px;
        cursor: pointer;
        z-index: 10;
        display: none;
    }

    /* ===== CHAT MESSAGES ===== */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 2rem 0;
        display: flex;
        flex-direction: column;
    }

    /* Welcome State */
    .welcome-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 2rem;
    }

    .welcome-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #004F87, #0088CC);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1.25rem;
    }

    .welcome-icon i {
        font-size: 1.8rem;
        color: white;
    }

    .welcome-state h2 {
        color: #FFFFFF;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .welcome-state p {
        color: rgba(255, 255, 255, 0.45);
        font-size: 0.95rem;
        margin-bottom: 2rem;
    }

    .welcome-chips {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        max-width: 550px;
    }

    .welcome-chip {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 14px 16px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        text-align: left;
        cursor: pointer;
        transition: all 0.2s;
    }

    .welcome-chip:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(0, 136, 204, 0.4);
        color: #fff;
        transform: translateY(-1px);
    }

    .welcome-chip i {
        margin-right: 6px;
        color: #0088CC;
        font-size: 0.8rem;
    }

    /* ===== MESSAGE BUBBLES ===== */
    .message-row {
        max-width: 800px;
        width: 100%;
        margin: 0 auto;
        padding: 0 2rem;
    }

    .message-user {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1rem;
    }

    .message-user .bubble {
        background: #1a3a5c;
        color: #FFFFFF;
        padding: 12px 18px;
        border-radius: 18px 18px 4px 18px;
        font-size: 0.95rem;
        max-width: 75%;
        line-height: 1.5;
    }

    .message-ai {
        margin-bottom: 1.5rem;
    }

    .ai-avatar-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .ai-avatar {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #004F87, #0088CC);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .ai-avatar i {
        color: white;
        font-size: 0.85rem;
    }

    .ai-label {
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.78rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .ai-answer-text {
        color: rgba(255, 255, 255, 0.88);
        font-size: 0.95rem;
        line-height: 1.8;
        padding-left: 42px;
    }

    .ai-answer-text ul {
        margin: 6px 0;
        padding-left: 20px;
    }

    .ai-answer-text li {
        margin-bottom: 4px;
    }

    .ai-answer-text .dataset-id-badge {
        display: inline-block;
        background: rgba(0, 136, 204, 0.15);
        color: #0088CC;
        font-size: 0.72rem;
        font-weight: 700;
        padding: 1px 6px;
        border-radius: 4px;
        margin: 0 2px;
    }

    .ai-answer-text .dataset-result-link {
        color: rgba(255, 255, 255, 0.85);
        text-decoration: none;
        border-bottom: 1px dashed rgba(0, 136, 204, 0.4);
        transition: color 0.2s, border-color 0.2s;
        display: inline;
    }

    .ai-answer-text .dataset-result-link:hover {
        color: #0088CC;
        border-bottom-color: #0088CC;
        text-decoration: none;
    }

    /* Typewriter cursor blink */
    .typewriter-cursor {
        display: inline-block;
        width: 2px;
        height: 1em;
        background: #0088CC;
        margin-left: 2px;
        animation: cursor-blink 0.7s step-end infinite;
        vertical-align: text-bottom;
    }

    @keyframes cursor-blink {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0;
        }
    }

    /* ===== RELATED RESEARCH SECTION ===== */
    .related-research {
        padding-left: 42px;
        margin-top: 16px;
    }

    .related-research-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .related-research-title {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.78rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .related-research-title i {
        font-size: 0.72rem;
        color: rgba(255, 255, 255, 0.3);
    }

    .view-more-results-btn {
        background: none;
        border: none;
        color: #0088CC;
        font-size: 0.78rem;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: color 0.2s;
        text-decoration: none;
    }

    .view-more-results-btn:hover {
        color: #33aadd;
        text-decoration: none;
    }

    .view-more-results-btn i {
        font-size: 0.7rem;
    }

    .research-list {
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    .research-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 9px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        text-decoration: none;
        transition: background 0.15s;
        border-radius: 0;
    }

    .research-item:last-child {
        border-bottom: none;
    }

    .research-item:hover {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
        padding-left: 6px;
        text-decoration: none;
    }

    .research-item-num {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.68rem;
        font-weight: 700;
        color: #fff;
        flex-shrink: 0;
    }

    .research-item-info {
        min-width: 0;
        flex: 1;
    }

    .research-item-title {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.83rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .research-item-meta {
        color: rgba(255, 255, 255, 0.3);
        font-size: 0.72rem;
        margin-top: 1px;
    }

    .research-item-arrow {
        color: rgba(255, 255, 255, 0.2);
        font-size: 0.7rem;
        flex-shrink: 0;
    }

    /* Source citations (small inline) */
    .source-pills {
        display: inline-flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 6px;
        padding-left: 42px;
    }

    .source-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 26px;
        height: 26px;
        border-radius: 50%;
        font-size: 0.72rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }

    .source-pill:hover {
        transform: scale(1.15);
        text-decoration: none;
    }

    .source-pill:nth-child(1) {
        background: #e74c3c;
        color: #fff;
    }

    .source-pill:nth-child(2) {
        background: #e67e22;
        color: #fff;
    }

    .source-pill:nth-child(3) {
        background: #f1c40f;
        color: #333;
    }

    .source-pill:nth-child(4) {
        background: #2ecc71;
        color: #fff;
    }

    .source-pill:nth-child(5) {
        background: #3498db;
        color: #fff;
    }

    .source-pill:nth-child(6) {
        background: #9b59b6;
        color: #fff;
    }

    .source-pill:nth-child(7) {
        background: #1abc9c;
        color: #fff;
    }

    .source-pill:nth-child(8) {
        background: #e91e63;
        color: #fff;
    }

    .source-pill:nth-child(9) {
        background: #00bcd4;
        color: #fff;
    }

    .source-pill:nth-child(10) {
        background: #ff9800;
        color: #fff;
    }

    /* Action bar under AI answer */
    .ai-actions {
        display: flex;
        align-items: center;
        gap: 4px;
        padding-left: 42px;
        margin-top: 14px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        padding-top: 10px;
    }

    .ai-action-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.35);
        font-size: 0.79rem;
        cursor: pointer;
        padding: 5px 8px;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .ai-action-btn:hover {
        color: rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.05);
    }

    .ai-action-btn i {
        font-size: 0.73rem;
    }

    .ai-action-btn.active {
        color: #0088CC;
    }

    .ai-action-divider {
        width: 1px;
        height: 16px;
        background: rgba(255, 255, 255, 0.1);
        margin: 0 4px;
    }

    /* Divider */
    .message-divider {
        max-width: 800px;
        width: 100%;
        margin: 0 auto 1.5rem;
        padding: 0 2rem;
    }

    .message-divider hr {
        border: none;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    /* Loading dots */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding-left: 42px;
        margin-top: 8px;
    }

    .typing-dot {
        width: 7px;
        height: 7px;
        background: rgba(0, 136, 204, 0.6);
        border-radius: 50%;
        animation: typing-bounce 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.16s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.32s;
    }

    @keyframes typing-bounce {

        0%,
        80%,
        100% {
            transform: scale(0.6);
            opacity: 0.4;
        }

        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Penguin searching animations */
    @keyframes penguin-pulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.12);
        }
    }

    @keyframes search-spin {

        0%,
        100% {
            transform: rotate(0deg);
        }

        25% {
            transform: rotate(-15deg);
        }

        75% {
            transform: rotate(15deg);
        }
    }

    .searching-dots::after {
        content: '';
        animation: searching-ellipsis 1.5s steps(4, end) infinite;
    }

    @keyframes searching-ellipsis {
        0% {
            content: '';
        }

        25% {
            content: '.';
        }

        50% {
            content: '..';
        }

        75% {
            content: '...';
        }
    }

    /* ===== BOTTOM INPUT BAR ===== */
    .chat-input-area {
        padding: 0 2rem 1rem;
        max-width: 840px;
        width: 100%;
        margin: 0 auto;
    }

    .chat-input-wrapper {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(0, 136, 204, 0.3);
        border-radius: 28px;
        padding: 4px;
        transition: all 0.3s;
    }

    .chat-input-wrapper:focus-within {
        border-color: rgba(0, 136, 204, 0.6);
        box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
        background: rgba(255, 255, 255, 0.06);
    }

    .input-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .input-icon {
        padding-left: 16px;
        color: rgba(255, 255, 255, 0.3);
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .chat-input {
        flex: 1;
        background: transparent !important;
        border: none;
        outline: none;
        color: #FFFFFF !important;
        font-size: 0.95rem;
        padding: 12px 0;
        font-family: inherit;
        caret-color: #0088CC;
        -webkit-text-fill-color: #FFFFFF;
    }

    .chat-input::placeholder {
        color: rgba(255, 255, 255, 0.35) !important;
        -webkit-text-fill-color: rgba(255, 255, 255, 0.35);
    }

    .send-btn {
        width: 42px;
        height: 42px;
        background: #0088CC;
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .send-btn:hover {
        background: #006fa3;
        transform: scale(1.05);
    }

    .send-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
    }

    .disclaimer {
        text-align: center;
        color: rgba(255, 255, 255, 0.2);
        font-size: 0.72rem;
        margin-top: 8px;
        line-height: 1.4;
    }

    /* ===== SCROLLBAR ===== */
    .chat-messages::-webkit-scrollbar,
    .sidebar-history::-webkit-scrollbar {
        width: 5px;
    }

    .chat-messages::-webkit-scrollbar-track,
    .sidebar-history::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb,
    .sidebar-history::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .chat-sidebar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            transform: translateX(-100%);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
        }

        .chat-sidebar.open {
            transform: translateX(0);
        }

        .chat-sidebar.collapsed {
            width: 260px !important;
            min-width: 260px !important;
        }

        .sidebar-toggle {
            display: block;
        }

        .scroll-nav {
            bottom: 80px;
            right: 8px;
        }

        .message-row {
            padding: 0 1rem;
        }

        .chat-input-area {
            padding: 0 1rem 1rem;
        }

        .welcome-chips {
            grid-template-columns: 1fr;
        }

        .ai-answer-text,
        .source-pills,
        .ai-actions,
        .related-research {
            padding-left: 0;
        }

        .related-research-header {
            flex-wrap: wrap;
            gap: 6px;
        }
    }
</style>

<script>
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const welcomeState = document.getElementById('welcome-state');
    const chatHistory = document.getElementById('chat-history');

    // ===== SESSION-BASED CHAT STORAGE =====
    // Each session: { id, title, time, html }
    let sessions = JSON.parse(localStorage.getItem('penguin_sessions') || '[]');
    let currentSessionId = null;   // null = welcome screen (no active session yet)
    let isProcessing = false;
    let currentQuery = '';

    function saveSessions() {
        localStorage.setItem('penguin_sessions', JSON.stringify(sessions));
    }

    // Save current chat HTML into the active session
    function saveCurrentSession() {
        if (!currentSessionId) return;
        const session = sessions.find(s => s.id === currentSessionId);
        if (session) {
            session.html = chatMessages.innerHTML;
            session.time = Date.now();
            saveSessions();
        }
    }

    // Create a new session (doesn't switch UI ‚Äî caller handles that)
    function createSession(title) {
        const id = 'session-' + Date.now();
        const session = { id, title, time: Date.now(), html: '' };
        sessions.unshift(session);
        // Keep max 30 sessions
        sessions = sessions.slice(0, 30);
        saveSessions();
        return id;
    }

    // Utility to escape HTML entities
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        renderHistory();
        chatInput.focus();
    });

    function askQuestion(text) {
        chatInput.value = text;
        sendMessage();
    }

    // Get CSRF token from cookie
    function getCsrfToken() {
        const name = 'csrftoken';
        const cookies = document.cookie.split(';');
        for (let c of cookies) {
            c = c.trim();
            if (c.startsWith(name + '=')) {
                return decodeURIComponent(c.substring(name.length + 1));
            }
        }
        return '';
    }

    function sendMessage(retryQuery) {
        const query = retryQuery || chatInput.value.trim();
        if (!query || query.length < 3 || isProcessing) return;

        isProcessing = true;
        currentQuery = query;
        document.getElementById('send-btn').disabled = true;

        // Hide welcome
        const ws = document.getElementById('welcome-state');
        if (ws) ws.style.display = 'none';

        // If no active session yet, create one now (first message in a new chat)
        if (!currentSessionId) {
            currentSessionId = createSession(query);
            renderHistory();
        }

        // Add user bubble (only if not a retry)
        if (!retryQuery) {
            appendUserMessage(query);
            chatInput.value = '';
        }

        // Add typing indicator
        const typingId = appendTypingIndicator();

        // Scroll down
        scrollToBottom();

        // 30-second timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        const fetchStart = performance.now();

        // Call API with CSRF token
        fetch('{% url "search:ai_rag_search" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ query: query, filters: {} }),
            signal: controller.signal
        })
            .then(res => {
                clearTimeout(timeoutId);
                if (res.status === 429) {
                    throw new Error('Too many requests. Please wait a moment before trying again.');
                }
                if (!res.ok) return res.json().then(d => { throw new Error(d.error || 'Search failed'); });
                return res.json();
            })
            .then(data => {
                const elapsed = ((performance.now() - fetchStart) / 1000).toFixed(1);
                removeTypingIndicator(typingId);
                appendAIMessage(data.answer || 'No answer available.', data.datasets || [], data.corrected_query, data.suggestions, elapsed);
                saveCurrentSession();
                scrollToBottom();
            })
            .catch(err => {
                removeTypingIndicator(typingId);
                let errorMsg;
                if (err.name === 'AbortError') {
                    errorMsg = 'Penguin is taking too long to respond. The server might be busy.';
                } else {
                    errorMsg = 'Sorry, I encountered an error: ' + err.message;
                }
                appendErrorMessage(errorMsg, query);
                saveCurrentSession();
                scrollToBottom();
            })
            .finally(() => {
                isProcessing = false;
                document.getElementById('send-btn').disabled = false;
            });
    }

    function appendErrorMessage(message, query) {
        const row = document.createElement('div');
        row.className = 'message-row message-ai';
        const safeQuery = escapeHtml(query).replace(/'/g, "\\'");
        row.innerHTML = `
            <div class="ai-avatar-row">
                <div class="ai-avatar">üêß</div>
                <span class="ai-label">Penguin</span>
            </div>
            <div class="ai-answer-text" style="color: rgba(255,200,200,0.9);">${escapeHtml(message)}</div>
            <div style="padding-left: 42px; margin-top: 10px;">
                <button onclick="sendMessage('${safeQuery}')" style="
                    background: rgba(0,136,204,0.15);
                    border: 1px solid rgba(0,136,204,0.4);
                    color: #0088CC;
                    padding: 8px 18px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 0.85rem;
                    transition: all 0.2s;
                " onmouseover="this.style.background='rgba(0,136,204,0.25)'" onmouseout="this.style.background='rgba(0,136,204,0.15)'">
                    <i class="fas fa-redo" style="margin-right: 6px;"></i>Try again
                </button>
            </div>
        `;
        chatMessages.appendChild(row);

        // Add divider
        const divider = document.createElement('div');
        divider.className = 'message-divider';
        divider.innerHTML = '<hr>';
        chatMessages.appendChild(divider);
    }

    function appendUserMessage(text) {
        const row = document.createElement('div');
        row.className = 'message-row message-user';
        row.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
        chatMessages.appendChild(row);
    }

    // Format raw AI text into clean HTML
    function formatAnswer(text) {
        if (!text) return '';
        const escaped = escapeHtml(text);
        const lines = escaped.split('\n');
        let html = '';
        let inList = false;

        lines.forEach(line => {
            const trimmed = line.trim();
            // Match *, -, ‚Ä¢, ‚óè bullet markers (AI commonly uses *)
            const isBullet = /^[-‚Ä¢‚óè*]\s+/.test(trimmed) || /^\d+\.\s+/.test(trimmed);

            if (isBullet) {
                if (!inList) { html += '<ul>'; inList = true; }
                let content = trimmed.replace(/^[-‚Ä¢‚óè*]\s+/, '').replace(/^\d+\.\s+/, '');
                // If this bullet has a dataset ID, make the whole item a clickable link
                const idMatch = content.match(/\[ID:\s*(\d+)\]/);
                if (idMatch) {
                    const datasetId = idMatch[1];
                    html += `<li><a href="/data/view/${datasetId}/" target="_blank" class="dataset-result-link">${content} <i class="fas fa-external-link-alt" style="font-size:0.65rem;opacity:0.5;margin-left:3px;"></i></a></li>`;
                } else {
                    html += `<li>${content}</li>`;
                }
            } else {
                if (inList) { html += '</ul>'; inList = false; }
                if (trimmed === '') {
                    html += '<br>';
                } else {
                    // Even non-bullet lines: if they contain [ID: X], make them a link
                    const idMatch = trimmed.match(/\[ID:\s*(\d+)\]/);
                    if (idMatch) {
                        const datasetId = idMatch[1];
                        html += `<p style="margin:0 0 4px 0"><a href="/data/view/${datasetId}/" target="_blank" class="dataset-result-link">${trimmed} <i class="fas fa-external-link-alt" style="font-size:0.65rem;opacity:0.5;margin-left:3px;"></i></a></p>`;
                    } else {
                        html += `<p style="margin:0 0 4px 0">${trimmed}</p>`;
                    }
                }
            }
        });
        if (inList) html += '</ul>';

        // Style [ID: X] references as badges
        html = html.replace(/\[ID:\s*(\d+)\]/g, '<span class="dataset-id-badge">[ID: $1]</span>');

        return html;
    }

    // Typewriter animation for AI answer text
    function typewriteText(element, text, onComplete) {
        const formattedHtml = formatAnswer(text);
        // Create a temp container to get the plain text content for word splitting
        const temp = document.createElement('div');
        temp.innerHTML = formattedHtml;

        // For simple typewriter: reveal the formatted HTML progressively
        element.innerHTML = '';
        const cursor = document.createElement('span');
        cursor.className = 'typewriter-cursor';
        element.appendChild(cursor);

        // Split into words for progressive reveal
        const words = text.split(/\s+/);
        let wordIndex = 0;
        let currentText = '';

        function addNextWord() {
            if (wordIndex < words.length) {
                currentText += (wordIndex > 0 ? ' ' : '') + words[wordIndex];
                wordIndex++;
                element.innerHTML = formatAnswer(currentText);
                element.appendChild(cursor);
                // Auto-scroll as text appears
                if (wordIndex % 5 === 0) scrollToBottom();
                setTimeout(addNextWord, 20);
            } else {
                // Done typing
                cursor.remove();
                element.innerHTML = formatAnswer(text);
                if (onComplete) onComplete();
            }
        }
        addNextWord();
    }

    function appendAIMessage(answer, datasets, correctedQuery, suggestions, responseTime) {
        const row = document.createElement('div');
        row.className = 'message-row message-ai';

        // Store query for "View other answers"
        row.dataset.query = currentQuery;

        // Build source pills (inline citations) ‚Äî only if datasets are cited
        let pillsHtml = '';
        if (datasets.length > 0) {
            pillsHtml = '<div class="source-pills" style="display:none;">';
            datasets.forEach((ds, i) => {
                pillsHtml += `<a class="source-pill" href="/data/view/${ds.id}/" target="_blank" title="${escapeHtml(ds.title)}">${i + 1}</a>`;
            });
            pillsHtml += '</div>';
        }

        // Build "Did you mean?" section
        let didYouMeanHtml = '';
        if (correctedQuery) {
            const safeQ = escapeHtml(correctedQuery).replace(/'/g, "\\'");
            didYouMeanHtml = `
                <div class="reveal-after-type" style="padding-left: 42px; margin-top: 12px; display:none;">
                    <div style="
                        background: rgba(0,136,204,0.08);
                        border: 1px solid rgba(0,136,204,0.25);
                        border-radius: 10px;
                        padding: 12px 16px;
                        display: inline-block;
                    ">
                        <i class="fas fa-lightbulb" style="color: #f1c40f; margin-right: 8px;"></i>
                        <span style="color: rgba(255,255,255,0.7); font-size: 0.88rem;">Did you mean: </span>
                        <a href="#" onclick="event.preventDefault(); sendMessage('${safeQ}');" style="
                            color: #0088CC;
                            font-weight: 600;
                            font-size: 0.9rem;
                            text-decoration: none;
                            border-bottom: 1px dashed rgba(0,136,204,0.5);
                        ">${escapeHtml(correctedQuery)}</a>
                    </div>
                </div>`;
        }

        // Build suggestion chips
        let suggestionsHtml = '';
        if (suggestions && suggestions.length > 0 && datasets.length === 0) {
            let chips = suggestions.map(s => {
                const safeS = escapeHtml(s).replace(/'/g, "\\'");
                return `<button onclick="sendMessage('${safeS}')" style="
                    background: rgba(255,255,255,0.05);
                    border: 1px solid rgba(255,255,255,0.15);
                    color: rgba(255,255,255,0.8);
                    padding: 6px 14px;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 0.82rem;
                    transition: all 0.2s;
                " onmouseover="this.style.background='rgba(0,136,204,0.15)'; this.style.borderColor='rgba(0,136,204,0.4)'; this.style.color='#0088CC';" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(255,255,255,0.15)'; this.style.color='rgba(255,255,255,0.8)';">
                    <i class="fas fa-search" style="margin-right: 5px; font-size: 0.75rem;"></i>${escapeHtml(s)}
                </button>`;
            }).join('');
            suggestionsHtml = `
                <div class="reveal-after-type" style="padding-left: 42px; margin-top: 10px; display:none;">
                    <div style="color: rgba(255,255,255,0.5); font-size: 0.82rem; margin-bottom: 8px;">Try searching for:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">${chips}</div>
                </div>`;
        }

        // Build related research section
        let relatedResearchHtml = '';
        if (datasets.length > 0) {
            relatedResearchHtml = '<div class="reveal-after-type" style="display:none;">' + buildRelatedResearch(datasets) + '</div>';
        }

        row.innerHTML = `
            <div class="ai-avatar-row">
                <div class="ai-avatar">üêß</div>
                <span class="ai-label">Penguin</span>
            </div>
            <div class="ai-answer-text"></div>
            ${pillsHtml}
            ${didYouMeanHtml}
            ${suggestionsHtml}
            ${relatedResearchHtml}
            ${responseTime ? `<div class="response-time-label reveal-after-type" style="display:none;"><i class="fas fa-clock" style="margin-right: 4px;"></i>Answered in ${responseTime}s</div>` : ''}
            <div class="ai-actions reveal-after-type" style="display:none;">
                <button class="ai-action-btn" onclick="shareAnswer(this)" title="Share">
                    <i class="fas fa-share"></i> Share
                </button>
                <div class="ai-action-divider"></div>
                <button class="ai-action-btn" onclick="viewOtherAnswers(this)" title="View other answers">
                    <i class="fas fa-sync-alt"></i> View other answers
                </button>
                <div class="ai-action-divider"></div>
                <button class="ai-action-btn" onclick="rateAnswer(this, 'up')" title="Helpful">
                    <i class="fas fa-thumbs-up"></i>
                </button>
                <button class="ai-action-btn" onclick="rateAnswer(this, 'down')" title="Not helpful">
                    <i class="fas fa-thumbs-down"></i>
                </button>
                <div class="ai-action-divider"></div>
                <button class="ai-action-btn" onclick="copyAnswer(this)" title="Copy answer">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        `;

        chatMessages.appendChild(row);

        // Add divider
        const divider = document.createElement('div');
        divider.className = 'message-divider';
        divider.innerHTML = '<hr>';
        chatMessages.appendChild(divider);

        // Start typewriter animation on the answer text
        const answerEl = row.querySelector('.ai-answer-text');
        typewriteText(answerEl, answer, () => {
            // Reveal all hidden elements after typing completes
            row.querySelectorAll('.reveal-after-type').forEach(el => {
                el.style.display = '';
            });
            // Show source pills
            const pills = row.querySelector('.source-pills');
            if (pills) pills.style.display = '';
            scrollToBottom();
        });
    }

    function buildRelatedResearch(datasets) {
        const colors = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6', '#1abc9c', '#e91e63', '#00bcd4', '#ff9800'];
        // Show first 4 inline, rest are hidden
        const showCount = Math.min(4, datasets.length);
        let html = `
            <div class="related-research">
                <div class="related-research-header">
                    <div class="related-research-title">
                        <i class="fas fa-book-open"></i> Related datasets
                    </div>
                    ${datasets.length > 0 ? `<a href="/search/?query=${encodeURIComponent(currentQuery)}" class="view-more-results-btn" title="View all results">
                        View all <i class="fas fa-arrow-right"></i>
                    </a>` : ''}
                </div>
                <div class="research-list" id="research-list-${Date.now()}">`;
        datasets.slice(0, showCount).forEach((ds, i) => {
            const color = colors[i % colors.length];
            const period = (ds.temporal_start && ds.temporal_end && ds.temporal_start !== 'None')
                ? `${ds.temporal_start} ‚Äî ${ds.temporal_end}` : '';
            html += `
                <a href="/data/view/${ds.id}/" target="_blank" class="research-item">
                    <span class="research-item-num" style="background:${color}">${i + 1}</span>
                    <div class="research-item-info">
                        <div class="research-item-title">${escapeHtml(ds.title)}</div>
                        <div class="research-item-meta">
                            ${ds.expedition_type ? escapeHtml(ds.expedition_type) : ''}
                            ${ds.category ? ` &bull; ${escapeHtml(ds.category)}` : ''}
                            ${period ? ` &bull; ${period}` : ''}
                        </div>
                    </div>
                    <i class="fas fa-chevron-right research-item-arrow"></i>
                </a>`;
        });
        html += `
                </div>
            </div>`;
        return html;
    }

    let typingCounter = 0;

    function appendTypingIndicator() {
        const id = 'typing-' + (++typingCounter);
        const row = document.createElement('div');
        row.className = 'message-row message-ai';
        row.id = id;
        row.innerHTML = `
            <div class="ai-avatar-row">
                <div class="ai-avatar" style="animation: penguin-pulse 1.5s ease-in-out infinite;">üêß</div>
                <span class="ai-label">Penguin</span>
            </div>
            <div class="typing-indicator">
                <i class="fas fa-search" style="color: #0088CC; font-size: 0.85rem; animation: search-spin 1.2s ease-in-out infinite;"></i>
                <span style="color: rgba(255,255,255,0.6); font-size: 0.88rem; margin-left: 6px;">Penguin is searching<span class="searching-dots"></span></span>
            </div>
            <div class="typing-indicator" style="margin-top: 4px;">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        `;
        chatMessages.appendChild(row);
        return id;
    }

    function removeTypingIndicator(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }

    function shareAnswer(btn) {
        const answerEl = btn.closest('.message-ai').querySelector('.ai-answer-text');
        if (navigator.share && answerEl) {
            navigator.share({ title: 'Penguin Answer', text: answerEl.textContent, url: window.location.href });
        } else {
            // Fallback: copy link
            navigator.clipboard.writeText(window.location.href).then(() => {
                const orig = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied link!';
                setTimeout(() => { btn.innerHTML = orig; }, 2000);
            });
        }
    }

    function viewOtherAnswers(btn) {
        const msgRow = btn.closest('.message-ai');
        const query = msgRow ? msgRow.dataset.query : '';
        if (!query || isProcessing) return;

        const orig = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        btn.disabled = true;

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        fetch('{% url "search:ai_rag_search" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ query: query, filters: {} }),
            signal: controller.signal
        })
            .then(res => {
                clearTimeout(timeoutId);
                if (!res.ok) throw new Error('Failed');
                return res.json();
            })
            .then(data => {
                // Replace the answer text in the same message row
                const answerEl = msgRow.querySelector('.ai-answer-text');
                if (answerEl && data.answer) {
                    typewriteText(answerEl, data.answer, () => {
                        btn.innerHTML = orig;
                        btn.disabled = false;
                    });
                } else {
                    btn.innerHTML = orig;
                    btn.disabled = false;
                }
            })
            .catch(() => {
                btn.innerHTML = orig;
                btn.disabled = false;
            });
    }

    function rateAnswer(btn, rating) {
        const actions = btn.closest('.ai-actions');
        const upBtn = actions.querySelector('[title="Helpful"], [title="Marked helpful"]');
        const downBtn = actions.querySelector('[title="Not helpful"], [title="Marked unhelpful"]');

        const isActive = btn.classList.contains('active');

        // Reset both
        if (upBtn) { upBtn.classList.remove('active'); upBtn.title = 'Helpful'; }
        if (downBtn) { downBtn.classList.remove('active'); downBtn.title = 'Not helpful'; }

        // Toggle the clicked one (if it wasn't already active)
        if (!isActive) {
            btn.classList.add('active');
            btn.title = rating === 'up' ? 'Marked helpful' : 'Marked unhelpful';
        }
    }

    function copyAnswer(btn) {
        const answerEl = btn.closest('.message-ai').querySelector('.ai-answer-text');
        if (answerEl) {
            navigator.clipboard.writeText(answerEl.textContent).then(() => {
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => { btn.innerHTML = '<i class="fas fa-copy"></i> Copy'; }, 2000);
            });
        }
    }

    // ===== SESSION-BASED HISTORY =====

    function renderHistory() {
        if (sessions.length === 0) {
            chatHistory.innerHTML = `
                <div class="history-empty">
                    <i class="fas fa-comment-dots"></i>
                    <p>Your search history will appear here</p>
                </div>`;
            return;
        }

        const now = Date.now();
        const dayMs = 86400000;
        const today = [], week = [], older = [];

        sessions.forEach(s => {
            const age = now - s.time;
            if (age < dayMs) today.push(s);
            else if (age < 7 * dayMs) week.push(s);
            else older.push(s);
        });

        let html = '';
        if (today.length) {
            html += '<div class="history-group-label">Today</div>';
            today.forEach(s => { html += historyItem(s); });
        }
        if (week.length) {
            html += '<div class="history-group-label">Past 7 days</div>';
            week.forEach(s => { html += historyItem(s); });
        }
        if (older.length) {
            html += '<div class="history-group-label">Older</div>';
            older.forEach(s => { html += historyItem(s); });
        }
        chatHistory.innerHTML = html;
    }

    function historyItem(s) {
        const safeId = escapeHtml(s.id).replace(/'/g, "\\'");
        const isActive = s.id === currentSessionId;
        return `<div class="history-item${isActive ? ' active-session' : ''}" onclick="switchToSession('${safeId}')">
            <i class="fas fa-search"></i>
            <span>${escapeHtml(s.title)}</span>
            <button class="history-delete-btn" onclick="event.stopPropagation(); deleteSession('${safeId}');" title="Remove">
                <i class="fas fa-times"></i>
            </button>
        </div>`;
    }

    // Switch to a saved session (restore its messages)
    function switchToSession(sessionId) {
        if (sessionId === currentSessionId) return; // already viewing it
        // Save current session first
        saveCurrentSession();

        const session = sessions.find(s => s.id === sessionId);
        if (!session) return;

        currentSessionId = sessionId;
        currentQuery = session.title;
        isProcessing = false;
        document.getElementById('send-btn').disabled = false;

        // Restore the saved HTML
        chatMessages.innerHTML = session.html || '';
        scrollToBottom();
        renderHistory(); // re-render so active highlight updates
    }

    function deleteSession(sessionId) {
        sessions = sessions.filter(s => s.id !== sessionId);
        saveSessions();
        // If we deleted the active session, go to welcome
        if (sessionId === currentSessionId) {
            newChat();
        } else {
            renderHistory();
        }
    }

    function filterHistory(term) {
        const items = chatHistory.querySelectorAll('.history-item');
        items.forEach(item => {
            item.style.display = item.textContent.toLowerCase().includes(term.toLowerCase()) ? '' : 'none';
        });
    }

    function newChat() {
        // Save any current session
        saveCurrentSession();

        // Reset to welcome state
        currentSessionId = null;
        currentQuery = '';
        isProcessing = false;
        document.getElementById('send-btn').disabled = false;

        // Rebuild welcome screen from scratch
        chatMessages.innerHTML = `
            <div class="welcome-state" id="welcome-state">
                <h2>üêß Penguin Search <small class="text-warning">alpha</small></h2>
                <p>Ask questions about India's polar and cryospheric research datasets</p>
                <div class="welcome-chips">
                    <button class="welcome-chip" onclick="askQuestion('What Antarctic ice sheet data is available?')">
                        <i class="fas fa-snowflake"></i> Antarctic ice sheet data
                    </button>
                    <button class="welcome-chip" onclick="askQuestion('Ocean temperature datasets from Southern Ocean')">
                        <i class="fas fa-water"></i> Southern Ocean temperature
                    </button>
                    <button class="welcome-chip" onclick="askQuestion('Himalayan glacier research datasets')">
                        <i class="fas fa-mountain"></i> Himalayan glacier research
                    </button>
                    <button class="welcome-chip" onclick="askQuestion('Arctic expedition data from recent years')">
                        <i class="fas fa-globe-americas"></i> Arctic expedition data
                    </button>
                </div>
            </div>`;
        renderHistory(); // clear active highlight
        chatInput.focus();
    }

    function toggleSidebarMobile() {
        document.getElementById('chat-sidebar').classList.toggle('open');
    }

    function toggleSidebarCollapse() {
        const sidebar = document.getElementById('chat-sidebar');
        const collapsed = sidebar.classList.toggle('collapsed');
        // Flip the arrow direction when collapsed
        const btn = document.getElementById('sidebar-collapse-btn');
        if (collapsed) {
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/><polyline points="15 18 21 12 15 6"/></svg>`;
        } else {
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="6"/><line x1="18" y1="12" x2="6" y2="12"/><line x1="18" y1="18" x2="6" y2="18"/><polyline points="9 18 3 12 9 6"/></svg>`;
        }
    }

    function scrollNav(direction) {
        const scrollAmount = 300;
        chatMessages.scrollBy({ top: direction === 'down' ? scrollAmount : -scrollAmount, behavior: 'smooth' });
    }

    // Show/hide scroll nav based on scroll position
    chatMessages.addEventListener('scroll', function () {
        const nav = document.getElementById('scroll-nav');
        if (nav) nav.style.opacity = chatMessages.scrollHeight > chatMessages.clientHeight ? '1' : '0';
    });

    function scrollToBottom() {
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 50);
    }

    // (escapeHtml is defined at the top of script ‚Äî duplicate removed)

    // ===== KEYBOARD SHORTCUTS =====
    document.addEventListener('keydown', function (e) {
        // Ctrl+K ‚Äî focus search input
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            chatInput.focus();
        }
        // Ctrl+N ‚Äî new chat
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            newChat();
        }
        // Escape ‚Äî close mobile sidebar
        if (e.key === 'Escape') {
            const sidebar = document.getElementById('chat-sidebar');
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }
        }
    });
</script>

{% endblock %}