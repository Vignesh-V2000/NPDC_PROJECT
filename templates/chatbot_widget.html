<!-- NPDC AI Chatbot Widget -->
<div id="npdc-chatbot-widget">
    <!-- Chat Toggle Button -->
    <button id="chatbot-toggle" class="chatbot-toggle" aria-label="Open Chat">
        <span style="font-size: 32px; line-height: 1;">üêß</span>
        <span class="chat-badge" id="chat-badge">1</span>
    </button>

    <!-- Proactive Tips Popup -->
    <div id="proactive-tip" class="proactive-tip hidden">
        <div class="proactive-tip-content">
            <div class="proactive-tip-icon" id="tip-icon">üí°</div>
            <div class="proactive-tip-text">
                <p class="proactive-tip-title" id="tip-title">Quick Tip</p>
                <p class="proactive-tip-message" id="tip-message">I can help with that!</p>
            </div>
            <button id="proactive-tip-close" class="proactive-tip-close">√ó</button>
        </div>
        <button id="proactive-tip-action" class="proactive-tip-action">Ask me about it</button>
        <div class="proactive-tip-arrow"></div>
    </div>

    <!-- Chat Panel -->
    <div id="chatbot-panel" class="chatbot-panel" style="display: none;">
        <!-- Chat Header -->
        <div class="chatbot-header">
            <div class="chatbot-drag-indicator" title="Drag to move">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" opacity="0.5">
                    <circle cx="9" cy="5" r="1"></circle>
                    <circle cx="15" cy="5" r="1"></circle>
                    <circle cx="9" cy="12" r="1"></circle>
                    <circle cx="15" cy="12" r="1"></circle>
                    <circle cx="9" cy="19" r="1"></circle>
                    <circle cx="15" cy="19" r="1"></circle>
                </svg>
            </div>
            <div class="chatbot-header-content">
                <div class="chatbot-avatar">
                    <span style="font-size: 28px; line-height: 1;">üêß</span>
                </div>
                <div class="chatbot-title">
                    <h3>Penguin</h3>
                    <p class="chatbot-subtitle">Your NPDC Assistant</p>
                </div>
            </div>
            <!-- Sound Toggle Button -->
            <button id="chatbot-sound-toggle" class="chatbot-sound-toggle" aria-label="Toggle Sound"
                title="Toggle Notifications">
                <svg id="sound-on-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                </svg>
                <svg id="sound-off-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <line x1="23" y1="9" x2="17" y2="15"></line>
                    <line x1="17" y1="9" x2="23" y2="15"></line>
                </svg>
            </button>
            <button id="chatbot-close" class="chatbot-close" aria-label="Close Chat">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="chatbot-messages" class="chatbot-messages">
            <!-- Messages will be dynamically added here -->
        </div>

        <!-- Quick Replies -->
        <div id="chatbot-quick-replies" class="chatbot-quick-replies" style="display: none;">
            <!-- Quick reply buttons will be added here -->
        </div>

        <!-- Chat Input -->
        <div class="chatbot-input-container">
            <div class="chatbot-typing" id="chatbot-typing" style="display: none;">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <form id="chatbot-form" class="chatbot-form">
                <input type="text" id="chatbot-input" class="chatbot-input" placeholder="Type your message..."
                    autocomplete="off" required />
                <button type="submit" class="chatbot-send" aria-label="Send message">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

<style>
    /* ==================== NPDC Chatbot Widget Styles ==================== */
    #npdc-chatbot-widget {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 9999;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Toggle Button - Glass Effect */
    .chatbot-toggle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, rgba(0, 51, 102, 0.85) 0%, rgba(0, 82, 204, 0.85) 100%);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        cursor: pointer;
        box-shadow: 0 8px 32px rgba(0, 51, 102, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        position: relative;
    }

    .chatbot-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 40px rgba(0, 51, 102, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    /* Pulse animation when user is stuck */
    .chatbot-toggle.pulse-help {
        animation: pulseHelp 1.5s infinite;
    }

    @keyframes pulseHelp {

        0%,
        100% {
            box-shadow: 0 8px 32px rgba(0, 51, 102, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: scale(1);
        }

        50% {
            box-shadow: 0 8px 48px rgba(0, 163, 161, 0.8), 0 0 20px rgba(0, 163, 161, 0.6);
            transform: scale(1.08);
        }
    }

    .chat-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #00A3A1;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }
    }

    /* Chat Panel - Glass Effect */
    .chatbot-panel {
        position: fixed;
        bottom: 100px;
        right: 24px;
        width: 380px;
        max-width: calc(100vw - 48px);
        height: 600px;
        max-height: calc(100vh - 140px);
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.5);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Chat Header - Glass Effect + Draggable */
    .chatbot-header {
        background: linear-gradient(135deg, rgba(0, 51, 102, 0.95) 0%, rgba(0, 82, 204, 0.95) 100%);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: white;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: grab;
        user-select: none;
    }

    .chatbot-header:active {
        cursor: grabbing;
    }

    .chatbot-drag-indicator {
        display: flex;
        align-items: center;
        margin-right: 8px;
        opacity: 0.6;
    }

    .chatbot-header-content {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }

    .chatbot-avatar {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chatbot-title h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: white !important;
        line-height: 1.2;
    }

    .chatbot-subtitle {
        margin: 0;
        font-size: 12px;
        opacity: 0.9;
        color: white !important;
    }

    .chatbot-close {
        background: transparent;
        border: none;
        color: white;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.2s;
    }

    .chatbot-close:hover {
        opacity: 0.8;
    }

    /* Sound Toggle Button */
    .chatbot-sound-toggle {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        cursor: pointer;
        padding: 6px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        margin-right: 8px;
    }

    .chatbot-sound-toggle:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .chatbot-sound-toggle .hidden {
        display: none;
    }

    /* Messages Container - Glass Effect */
    .chatbot-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: linear-gradient(180deg, rgba(249, 250, 251, 0.7) 0%, rgba(241, 245, 249, 0.8) 100%);
        scroll-behavior: smooth;
    }

    .chatbot-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chatbot-messages::-webkit-scrollbar-track {
        background: #f1f5f9;
    }

    .chatbot-messages::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    /* Message Bubbles */
    .chat-message {
        margin-bottom: 16px;
        display: flex;
        animation: messageSlide 0.3s ease;
    }

    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chat-message.user {
        justify-content: flex-end;
    }

    .chat-message.bot {
        justify-content: flex-start;
    }

    .message-content {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: 12px;
        line-height: 1.5;
        font-size: 14px;
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        word-break: break-word;
    }

    .chat-message.user .message-content {
        background: linear-gradient(135deg, rgba(0, 51, 102, 0.9) 0%, rgba(0, 82, 204, 0.9) 100%);
        color: white;
        border-bottom-right-radius: 4px;
        box-shadow: 0 4px 15px rgba(0, 51, 102, 0.25);
    }

    .chat-message.bot .message-content {
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        color: #1f2937;
        border-bottom-left-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .message-content a {
        color: #00A3A1;
        text-decoration: underline;
    }

    .chat-message.user .message-content a {
        color: #00D4D0;
    }

    /* Quick Replies */
    .chatbot-quick-replies {
        padding: 12px 20px;
        background: white;
        border-top: 1px solid #e5e7eb;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .quick-reply-btn {
        background: white;
        border: 1px solid #00A3A1;
        color: #00A3A1;
        padding: 8px 14px;
        border-radius: 20px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .quick-reply-btn:hover {
        background: #00A3A1;
        color: white;
    }

    /* Typing Indicator */
    .chatbot-typing {
        padding: 12px 16px;
        background: white;
        border-radius: 12px;
        border-bottom-left-radius: 4px;
        display: inline-flex;
        gap: 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        margin-bottom: 16px;
    }

    .chatbot-typing span {
        width: 8px;
        height: 8px;
        background: #94a3b8;
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }

    .chatbot-typing span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .chatbot-typing span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {

        0%,
        60%,
        100% {
            transform: translateY(0);
        }

        30% {
            transform: translateY(-8px);
        }
    }

    /* Input Container - Glass Effect */
    .chatbot-input-container {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-top: 1px solid rgba(255, 255, 255, 0.3);
        padding: 16px 20px;
    }

    .chatbot-form {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .chatbot-input {
        flex: 1;
        border: 1px solid rgba(209, 213, 219, 0.6);
        border-radius: 24px;
        padding: 10px 16px;
        font-size: 14px;
        outline: none;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.2s;
    }

    .chatbot-input:focus {
        border-color: #00A3A1;
        box-shadow: 0 0 0 3px rgba(0, 163, 161, 0.15);
    }

    .chatbot-send {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, rgba(0, 51, 102, 0.9) 0%, rgba(0, 82, 204, 0.9) 100%);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(0, 51, 102, 0.3);
    }

    .chatbot-send:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 51, 102, 0.4);
    }

    .chatbot-send:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
        .chatbot-panel {
            bottom: 90px;
            right: 12px;
            left: 12px;
            width: auto;
            max-width: none;
        }

        #npdc-chatbot-widget {
            bottom: 16px;
            right: 16px;
        }
    }

    /* Proactive Tips Popup */
    .proactive-tip {
        position: fixed;
        bottom: 170px;
        right: 24px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 16px;
        padding: 14px 16px;
        box-shadow: 0 8px 32px rgba(0, 51, 102, 0.2);
        border: 1px solid rgba(0, 163, 161, 0.2);
        z-index: 99999;
        animation: tipSlideIn 0.4s ease;
        max-width: 280px;
    }

    @keyframes tipSlideIn {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .proactive-tip-content {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        position: relative;
    }

    .proactive-tip-icon {
        font-size: 24px;
        flex-shrink: 0;
        animation: tipPulse 2s infinite;
    }

    @keyframes tipPulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }
    }

    .proactive-tip-text {
        flex: 1;
        padding-right: 20px;
    }

    .proactive-tip-title {
        font-weight: 600;
        color: #003366;
        font-size: 13px;
        margin: 0 0 4px 0;
    }

    .proactive-tip-message {
        font-size: 12px;
        color: #4b5563;
        margin: 0;
        line-height: 1.4;
    }

    .proactive-tip-close {
        position: absolute;
        top: -2px;
        right: 0;
        background: none;
        border: none;
        font-size: 18px;
        color: #9ca3af;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
    }

    .proactive-tip-close:hover {
        color: #374151;
    }

    .proactive-tip-action {
        width: 100%;
        margin-top: 10px;
        padding: 8px 16px;
        background: linear-gradient(135deg, rgba(0, 51, 102, 0.9) 0%, rgba(0, 82, 204, 0.9) 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .proactive-tip-action:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 51, 102, 0.3);
    }

    .proactive-tip-arrow {
        position: absolute;
        bottom: -8px;
        right: 30px;
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid rgba(255, 255, 255, 0.95);
    }

    .proactive-tip.hidden {
        display: none;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .faq-popup.hidden {
        display: none;
    }

    /* ===== ASK PENGUIN TEXT TOOLTIP ===== */
    .ask-penguin-tooltip {
        display: inline-block;
        position: absolute;
        right: 0;
        top: -28px;
        padding: 4px 12px;
        background: #1a1a2e;
        color: #fff;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        font-family: 'Inter', sans-serif;
        letter-spacing: 0.2px;
        cursor: pointer;
        white-space: nowrap;
        z-index: 10001;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease, visibility 0.2s ease;
        user-select: none;
        line-height: 1;
        pointer-events: none;
    }

    .ask-penguin-tooltip.visible {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }

    .ask-penguin-tooltip:hover {
        background: #2d2d44;
    }

    /* Wrapper to position tooltip outside above the field */
    .ask-penguin-field-wrapper {
        position: relative;
    }
</style>

<script>
    (function () {
        'use strict';

        const NPDCChatbot = {
            isOpen: false,
            conversationHistory: [],
            isWaitingForResponse: false,
            tipShown: false,
            currentTipAction: null,

            // Sound settings
            soundSettings: {
                enabled: true,
                volume: 0.3,
                audioContext: null,
            },

            // Stuck detection state
            stuckDetection: {
                enabled: true,
                lastActivity: Date.now(),
                idleThreshold: 45000, // 45 seconds idle triggers help
                focusedField: null,
                fieldFocusCount: {},
                fieldFocusThreshold: 3, // 3 focuses on same field = stuck
                stuckAlertShown: false,
                formErrorCount: 0,
                scrollPattern: [],
            },

            init() {
                this.cacheElements();
                this.attachEventListeners();
                this.initializeChat();
                this.initStuckDetection(); // Initialize stuck detection
                this.initSoundSystem(); // Initialize sound notifications
                this.initPenguinHelpIcons(); // Initialize Ask Penguin help icons
            },

            getCurrentPageContext() {
                const path = window.location.pathname;
                const pageName = document.title || 'NPDC Portal';

                let pageType = 'home';
                let pageContext = '';
                let pageHints = [];

                // Dataset submission pages
                if (path.includes('/data/submit')) {
                    pageType = 'submit';
                    pageContext = 'User is on the DATASET SUBMISSION PAGE where they can submit new research data.';
                    pageHints = ['Help with metadata fields', 'Expedition type selection', 'File upload guidance'];
                }
                else if (path.match(/\/data\/view\/\d+/)) {
                    pageType = 'view_submission';
                    pageContext = 'User is VIEWING A SPECIFIC DATASET SUBMISSION with all its details.';
                    pageHints = ['Submission status info', 'Edit/Update guidance', 'Download options'];
                }
                else if (path.includes('/data/my-submissions')) {
                    pageType = 'my_submissions';
                    pageContext = 'User is viewing THEIR SUBMITTED DATASETS list showing all their submissions and statuses.';
                    pageHints = ['Submission status explanation', 'How to track review', 'Resubmit guidance'];
                }
                else if (path.includes('/data/success')) {
                    pageType = 'submission_success';
                    pageContext = 'User just SUCCESSFULLY SUBMITTED a dataset and sees confirmation.';
                    pageHints = ['What happens next', 'Track submission status', 'Contact for help'];
                }
                // Admin/Reviewer pages
                else if (path.includes('/data/admin/dashboard')) {
                    pageType = 'admin_dashboard';
                    pageContext = 'User is on the ADMIN DASHBOARD viewing overall submission statistics.';
                    pageHints = ['Dashboard features', 'Review workflow', 'Admin actions'];
                }
                else if (path.match(/\/data\/admin\/review\/\d+/)) {
                    pageType = 'review_detail';
                    pageContext = 'Reviewer is REVIEWING A SPECIFIC SUBMISSION in detail.';
                    pageHints = ['Review process', 'Approval/Rejection guidance', 'Feedback options'];
                }
                else if (path.includes('/data/admin/review')) {
                    pageType = 'review_list';
                    pageContext = 'Reviewer is viewing the LIST OF SUBMISSIONS to review.';
                    pageHints = ['Review queue info', 'Priority handling', 'Bulk actions'];
                }
                // Account pages
                else if (path.includes('/login')) {
                    pageType = 'login';
                    pageContext = 'User is on the LOGIN PAGE.';
                    pageHints = ['Login help', 'Password reset', 'Registration link'];
                }
                else if (path.includes('/register')) {
                    pageType = 'register';
                    pageContext = 'User is on the REGISTRATION PAGE to create a new account.';
                    pageHints = ['Registration requirements', 'Account benefits', 'After registration steps'];
                }
                else if (path.includes('/profile')) {
                    pageType = 'profile';
                    pageContext = 'User is viewing their PROFILE PAGE with account details.';
                    pageHints = ['Profile settings', 'Update information', 'Account options'];
                }
                else if (path.includes('/dashboard')) {
                    pageType = 'dashboard';
                    pageContext = 'User is on their personal DASHBOARD showing recent activity and overview.';
                    pageHints = ['Dashboard features', 'Quick actions', 'Recent activity'];
                }
                // Search page
                else if (path.includes('/search')) {
                    pageType = 'search';
                    pageContext = 'User is on the DATASET SEARCH PAGE with AI-powered Smart Search. Features include: Penguin Smart Search toggle for AI-enhanced searching, natural language query understanding, AI-generated result summaries, and zero-result recovery with alternative suggestions.';
                    pageHints = ['Search tips', 'Penguin Smart Search features', 'Filter guidance', 'Natural language queries'];
                }
                // Home page
                else if (path === '/' || path === '/home' || path === '') {
                    pageType = 'home';
                    pageContext = 'User is on the NPDC HOME PAGE - main landing page of the portal.';
                    pageHints = ['Getting started', 'Portal overview', 'How to submit data'];
                }
                // Fallback
                else {
                    pageType = 'other';
                    pageContext = `User is browsing the portal at path: ${path}`;
                    pageHints = ['General help', 'Navigation assistance'];
                }

                return {
                    pageType: pageType,
                    pagePath: path,
                    pageContext: pageContext,
                    pageTitle: pageName,
                    pageHints: pageHints
                };
            },

            cacheElements() {
                this.toggle = document.getElementById('chatbot-toggle');
                this.panel = document.getElementById('chatbot-panel');
                this.close = document.getElementById('chatbot-close');
                this.messagesContainer = document.getElementById('chatbot-messages');
                this.form = document.getElementById('chatbot-form');
                this.input = document.getElementById('chatbot-input');
                this.quickReplies = document.getElementById('chatbot-quick-replies');
                this.badge = document.getElementById('chat-badge');
                this.typingIndicator = document.getElementById('chatbot-typing');
                // Proactive tips elements
                this.proactiveTip = document.getElementById('proactive-tip');
                this.tipIcon = document.getElementById('tip-icon');
                this.tipTitle = document.getElementById('tip-title');
                this.tipMessage = document.getElementById('tip-message');
                this.tipClose = document.getElementById('proactive-tip-close');
                this.tipAction = document.getElementById('proactive-tip-action');
                // Sound toggle elements
                this.soundToggle = document.getElementById('chatbot-sound-toggle');
                this.soundOnIcon = document.getElementById('sound-on-icon');
                this.soundOffIcon = document.getElementById('sound-off-icon');
            },

            attachEventListeners() {
                this.toggle.addEventListener('click', () => this.toggleChat());
                this.close.addEventListener('click', () => this.toggleChat());
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));

                // Proactive tips event listeners
                this.tipClose.addEventListener('click', () => this.hideProactiveTip());
                this.tipAction.addEventListener('click', () => this.handleTipAction());

                // Sound toggle event listener
                this.soundToggle.addEventListener('click', () => this.handleSoundToggle());

                // Drag functionality
                this.initDrag();

                // Show proactive tip after delay based on current page
                setTimeout(() => {
                    if (!this.isOpen && !this.tipShown) {
                        this.showPageTip();
                    }
                }, 5000);
            },

            // Get page-specific tips
            getPageTips() {
                const pageInfo = this.getCurrentPageContext();
                const pageType = pageInfo.pageType;

                const tips = {
                    'home': {
                        icon: 'üè†',
                        title: 'Welcome to NPDC!',
                        message: 'Need help getting started? I can guide you through submitting your research data.',
                        action: 'How do I submit a dataset?'
                    },
                    'submit': {
                        icon: 'üìù',
                        title: 'Submitting Data?',
                        message: 'I can explain each field and help you fill out the form correctly.',
                        action: 'Explain the metadata fields'
                    },
                    'my_submissions': {
                        icon: 'üìä',
                        title: 'Track Your Submissions',
                        message: 'I can explain submission statuses and the review process.',
                        action: 'How does the review process work?'
                    },
                    'view_submission': {
                        icon: 'üîç',
                        title: 'Viewing Dataset Details',
                        message: 'Need help understanding any field or want to know what happens next?',
                        action: 'What do these fields mean?'
                    },
                    'login': {
                        icon: 'üîê',
                        title: 'Need Help Logging In?',
                        message: 'I can help with account access or guide you to register.',
                        action: 'How do I create an account?'
                    },
                    'register': {
                        icon: '‚ú®',
                        title: 'Creating an Account',
                        message: 'I can explain the registration requirements and benefits.',
                        action: 'What are the benefits of registering?'
                    },
                    'admin_dashboard': {
                        icon: 'üìà',
                        title: 'Dashboard Overview',
                        message: 'I can help explain the statistics and admin features.',
                        action: 'How do I review submissions?'
                    },
                    'review_list': {
                        icon: 'üìã',
                        title: 'Review Queue',
                        message: 'I can guide you through the review workflow.',
                        action: 'How do I approve a submission?'
                    },
                    'profile': {
                        icon: 'üë§',
                        title: 'Your Profile',
                        message: 'Need help updating your information or settings?',
                        action: 'How do I update my profile?'
                    },
                    'search': {
                        icon: 'ÔøΩ',
                        title: 'Searching Datasets?',
                        message: 'Try our Penguin-powered Smart Search! I can help you find data with natural language queries.',
                        action: 'How does Smart Search work?'
                    }
                };

                return tips[pageType] || {
                    icon: 'üí°',
                    title: 'Need Assistance?',
                    message: 'I\'m here to help with any questions about the NPDC portal.',
                    action: 'What can you help me with?'
                };
            },

            showPageTip() {
                const tip = this.getPageTips();
                this.tipIcon.textContent = tip.icon;
                this.tipTitle.textContent = tip.title;
                this.tipMessage.textContent = tip.message;
                this.tipAction.textContent = tip.action;
                this.currentTipAction = tip.action;

                this.proactiveTip.classList.remove('hidden');
                this.tipShown = true;

                // Auto-hide after 15 seconds
                setTimeout(() => {
                    this.hideProactiveTip();
                }, 15000);
            },

            hideProactiveTip() {
                if (this.proactiveTip) {
                    this.proactiveTip.classList.add('hidden');

                    // Show progress panel after proactive tip disappears
                    setTimeout(() => {
                        const progressPanel = document.getElementById('ai-progress-panel');
                        if (progressPanel) {
                            progressPanel.style.display = 'block';
                            // Trigger animation
                            progressPanel.style.animation = 'popFromPenguin 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
                        }
                    }, 300); // Small delay for smooth transition
                }
            },

            // ===== ASK PENGUIN FIELD HELP ICONS =====
            initPenguinHelpIcons() {
                const pageInfo = this.getCurrentPageContext();

                // Only add help icons on form pages
                if (!['submit', 'register', 'login', 'profile'].includes(pageInfo.pageType)) {
                    return;
                }

                // Small delay to ensure form is rendered
                setTimeout(() => {
                    this.injectPenguinHelpIcons();
                }, 500);

                console.log('üêß Penguin help icons initialized');
            },

            injectPenguinHelpIcons() {
                // Find all form fields with labels
                const formGroups = document.querySelectorAll('.form-group, .mb-3, .form-floating, [class*="col-"]');

                formGroups.forEach(group => {
                    const label = group.querySelector('label');
                    const field = group.querySelector('input, textarea, select');

                    // Skip if no label or field, or if tooltip already exists
                    if (!label || !field || group.querySelector('.ask-penguin-tooltip')) {
                        return;
                    }

                    // Get field identifier
                    const fieldId = this.getFieldIdentifier(field);
                    if (!fieldId) return;

                    // Get help info for this field
                    const helpInfo = this.getFieldHelp(fieldId, 'penguin_icon');
                    if (!helpInfo || helpInfo.title === 'Need Help?') {
                        return;
                    }

                    // Wrap the field in a relative container if not already
                    const fieldParent = field.parentElement;
                    let wrapper = fieldParent;
                    if (!fieldParent.classList.contains('ask-penguin-field-wrapper')) {
                        wrapper = document.createElement('div');
                        wrapper.className = 'ask-penguin-field-wrapper';
                        fieldParent.insertBefore(wrapper, field);
                        wrapper.appendChild(field);
                    }

                    // Create minimal "Ask Penguin" text tooltip
                    const tooltip = document.createElement('span');
                    tooltip.className = 'ask-penguin-tooltip';
                    tooltip.textContent = 'Ask Penguin';
                    tooltip.setAttribute('role', 'button');
                    tooltip.setAttribute('aria-label', `Ask Penguin about ${helpInfo.title}`);
                    tooltip.setAttribute('tabindex', '0');
                    tooltip.setAttribute('data-field-id', fieldId);

                    // Click handler - open chat with question
                    tooltip.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üêß Ask Penguin clicked for field:', fieldId);
                        this.askPenguinAboutField(fieldId, helpInfo);
                    });

                    // Keyboard accessibility
                    tooltip.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.askPenguinAboutField(fieldId, helpInfo);
                        }
                    });

                    // Append tooltip inside the wrapper
                    wrapper.appendChild(tooltip);

                    // Show tooltip on field focus
                    field.addEventListener('focus', () => {
                        tooltip.classList.add('visible');
                    });

                    // Hide tooltip on field blur (with longer delay for above-field positioning)
                    field.addEventListener('blur', () => {
                        setTimeout(() => {
                            tooltip.classList.remove('visible');
                        }, 500);
                    });

                    // Also hide if clicking outside
                    tooltip.addEventListener('mouseleave', () => {
                        if (document.activeElement !== field) {
                            tooltip.classList.remove('visible');
                        }
                    });
                });
            },

            askPenguinAboutField(fieldId, helpInfo) {
                console.log('üêß askPenguinAboutField called for:', fieldId, helpInfo);

                // Open chat if not open
                if (!this.isOpen) {
                    this.toggleChat();
                }

                // Build context-aware question
                const pageInfo = this.getCurrentPageContext();
                let question = helpInfo.action || `Help me with the ${fieldId} field`;

                // Add page/section context if not already present in the action
                if (!question.includes('form') && !question.includes('Form')) {
                    const sectionMap = {
                        'submit': 'Dataset Submission form',
                        'register': 'Registration form',
                        'login': 'Login form',
                        'profile': 'Profile page'
                    };
                    const sectionName = sectionMap[pageInfo.pageType] || 'form';
                    const fieldLabel = fieldId.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                    question = `[On the ${sectionName} - ${fieldLabel} field] ${question}`;
                }

                // Send the question to the chatbot
                setTimeout(() => {
                    this.input.value = question;
                    console.log('üêß Sending to chatbot:', question);
                    this.form.dispatchEvent(new Event('submit'));
                }, 300);
            },

            handleTipAction() {
                this.hideProactiveTip();
                this.toggleChat();

                // Auto-ask the suggested question
                setTimeout(() => {
                    if (this.currentTipAction) {
                        this.input.value = this.currentTipAction;
                        this.form.dispatchEvent(new Event('submit'));
                    }
                }, 500);
            },

            // ===== STUCK DETECTION SYSTEM =====
            initStuckDetection() {
                const pageInfo = this.getCurrentPageContext();

                // Only enable on form pages
                if (!['submit', 'register', 'login'].includes(pageInfo.pageType)) {
                    this.stuckDetection.enabled = false;
                    return;
                }

                // Track all form inputs
                this.trackFormFields();

                // Start idle checker
                this.startIdleChecker();

                // Track form errors
                this.trackFormErrors();

                console.log('üîç Stuck detection initialized for:', pageInfo.pageType);
            },

            trackFormFields() {
                const formFields = document.querySelectorAll('input, textarea, select');

                formFields.forEach(field => {
                    // Track focus events
                    field.addEventListener('focus', (e) => {
                        this.handleFieldFocus(e.target);
                    });

                    // Reset on activity
                    field.addEventListener('input', () => {
                        this.recordActivity();
                    });
                });
            },

            handleFieldFocus(field) {
                // Better field identification - check multiple attributes
                const fieldId = this.getFieldIdentifier(field);
                this.stuckDetection.focusedField = fieldId;

                // Count focus on same field
                if (!this.stuckDetection.fieldFocusCount[fieldId]) {
                    this.stuckDetection.fieldFocusCount[fieldId] = 0;
                }
                this.stuckDetection.fieldFocusCount[fieldId]++;

                // Check if user is repeatedly focusing same field (stuck)
                if (this.stuckDetection.fieldFocusCount[fieldId] >= this.stuckDetection.fieldFocusThreshold) {
                    this.triggerStuckHelp(fieldId, 'repeated_focus');
                    this.stuckDetection.fieldFocusCount[fieldId] = 0; // Reset
                }

                this.recordActivity();
            },

            // Get best identifier for a form field
            getFieldIdentifier(field) {
                const pageInfo = this.getCurrentPageContext();
                const pageType = pageInfo.pageType;

                // Priority 1: Check field type for common patterns
                const fieldType = field.type?.toLowerCase() || '';
                if (fieldType === 'email') return 'email';
                if (fieldType === 'password') return 'password';

                // Priority 2: Check placeholder text
                const placeholder = field.placeholder?.toLowerCase() || '';
                if (placeholder.includes('email')) return 'email';
                if (placeholder.includes('password')) return 'password';
                if (placeholder.includes('username')) return 'username';
                if (placeholder.includes('abstract')) return 'abstract';

                // Priority 3: Check associated label
                const label = this.getFieldLabel(field);
                if (label.includes('email')) return 'email';
                if (label.includes('password')) return 'password';
                if (label.includes('username')) return 'username';
                if (label.includes('abstract')) return 'abstract';
                if (label.includes('keyword')) return 'keywords';
                if (label.includes('expedition')) return 'expedition_type';

                // Page-aware title detection: differentiate metadata title vs registration title
                if (placeholder.includes('title') || label.includes('title')) {
                    if (pageType === 'submit') return 'metadata_title';
                    if (pageType === 'register') return 'reg_title';
                    return 'title';
                }

                // Priority 4: Check id/name attributes
                const id = field.id?.toLowerCase() || '';
                const name = field.name?.toLowerCase() || '';

                if (id.includes('email') || name.includes('email')) return 'email';
                if (id.includes('password') || name.includes('password')) return 'password';
                if (id.includes('username') || name.includes('username')) return 'username';
                if (id.includes('expedition') || name.includes('expedition')) return 'expedition_type';

                // Page-aware title detection from id/name
                if (id.includes('title') || name.includes('title')) {
                    if (pageType === 'submit') return 'metadata_title';
                    if (pageType === 'register') return 'reg_title';
                    return 'title';
                }

                // Priority 5: Handle radio buttons and checkboxes (strip the _0, _1 suffix)
                let baseId = field.id || field.name || 'form_field';
                // For radio buttons like id_expedition_type_0, return id_expedition_type
                baseId = baseId.replace(/_\d+$/, '');

                return baseId;
            },

            getFieldLabel(field) {
                // Check for label with 'for' attribute
                if (field.id) {
                    const label = document.querySelector(`label[for="${field.id}"]`);
                    if (label) return label.textContent.toLowerCase();
                }

                // Check for parent label
                const parentLabel = field.closest('label');
                if (parentLabel) return parentLabel.textContent.toLowerCase();

                // Check for sibling label or nearby text
                const parent = field.parentElement;
                if (parent) {
                    const label = parent.querySelector('label');
                    if (label) return label.textContent.toLowerCase();
                }

                return '';
            },

            recordActivity() {
                this.stuckDetection.lastActivity = Date.now();
                this.stuckDetection.stuckAlertShown = false;
            },

            startIdleChecker() {
                setInterval(() => {
                    if (!this.stuckDetection.enabled || this.isOpen) return;

                    const idleTime = Date.now() - this.stuckDetection.lastActivity;

                    if (idleTime > this.stuckDetection.idleThreshold && !this.stuckDetection.stuckAlertShown) {
                        this.triggerStuckHelp(this.stuckDetection.focusedField, 'idle');
                    }
                }, 10000); // Check every 10 seconds
            },

            trackFormErrors() {
                // Watch for HTML5 validation errors
                document.addEventListener('invalid', (e) => {
                    this.stuckDetection.formErrorCount++;

                    // Get the actual error message
                    const field = e.target;
                    const fieldId = this.getFieldIdentifier(field);
                    const errorMessage = this.getFieldErrorMessage(field);

                    if (this.stuckDetection.formErrorCount >= 2) {
                        this.triggerStuckHelp(fieldId, 'validation_error', errorMessage);
                        this.stuckDetection.formErrorCount = 0;
                    }
                }, true);

                // Also watch for Django/custom error messages that appear in the DOM
                this.observeErrorMessages();
            },

            getFieldErrorMessage(field) {
                // Priority 1: HTML5 validation message
                if (field.validationMessage) {
                    return field.validationMessage;
                }

                // Priority 2: Check for adjacent error elements
                const errorSelectors = [
                    '.error-message',
                    '.field-error',
                    '.invalid-feedback',
                    '.help-block.error',
                    '.errorlist li',
                    '[class*="error"]'
                ];

                // Check siblings and parent containers
                const parent = field.closest('.form-group, .field-wrapper, .mb-3, div');
                if (parent) {
                    for (const selector of errorSelectors) {
                        const errorEl = parent.querySelector(selector);
                        if (errorEl && errorEl.textContent.trim()) {
                            return errorEl.textContent.trim();
                        }
                    }
                }

                // Priority 3: Check for aria-describedby error
                const describedBy = field.getAttribute('aria-describedby');
                if (describedBy) {
                    const errorEl = document.getElementById(describedBy);
                    if (errorEl && errorEl.textContent.trim()) {
                        return errorEl.textContent.trim();
                    }
                }

                return null;
            },

            observeErrorMessages() {
                // Watch for dynamically added error messages (Django, AJAX, etc.)
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // Check if it's an error message element
                                const isError = node.classList?.contains('error') ||
                                    node.classList?.contains('errorlist') ||
                                    node.classList?.contains('invalid-feedback') ||
                                    node.textContent?.toLowerCase().includes('error') ||
                                    node.textContent?.toLowerCase().includes('required');

                                if (isError && node.textContent?.trim()) {
                                    // Find the related field
                                    const parent = node.closest('.form-group, .field-wrapper, .mb-3, div');
                                    if (parent) {
                                        const field = parent.querySelector('input, textarea, select');
                                        if (field) {
                                            const fieldId = this.getFieldIdentifier(field);
                                            const errorMessage = node.textContent.trim();

                                            // Only trigger if not already shown
                                            if (!this.stuckDetection.stuckAlertShown) {
                                                this.triggerStuckHelp(fieldId, 'validation_error', errorMessage);
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    });
                });

                // Observe the entire document for error messages
                const forms = document.querySelectorAll('form');
                forms.forEach(form => {
                    observer.observe(form, { childList: true, subtree: true });
                });
            },

            triggerStuckHelp(fieldId, reason, errorMessage = null) {
                if (this.stuckDetection.stuckAlertShown || this.isOpen) return;

                const helpInfo = this.getFieldHelp(fieldId, reason, errorMessage);

                // Update proactive tip with stuck-specific content
                this.tipIcon.textContent = helpInfo.icon;
                this.tipTitle.textContent = helpInfo.title;
                this.tipMessage.textContent = helpInfo.message;
                this.tipAction.textContent = helpInfo.action;

                // Store the action with error context for AI
                if (errorMessage && reason === 'validation_error') {
                    this.currentTipAction = `I'm getting this error on the ${fieldId} field: "${errorMessage}". Help me fix it.`;
                } else {
                    this.currentTipAction = helpInfo.action;
                }

                // Add pulse animation to chat toggle
                this.toggle.classList.add('pulse-help');

                // Play tip notification sound
                this.playTipSound();

                this.proactiveTip.classList.remove('hidden');
                this.stuckDetection.stuckAlertShown = true;

                // Auto-hide after 20 seconds
                setTimeout(() => {
                    this.hideProactiveTip();
                    this.toggle.classList.remove('pulse-help');
                }, 20000);
            },

            // ===== SOUND NOTIFICATION SYSTEM =====
            initSoundSystem() {
                // Load sound preference from localStorage
                const savedPref = localStorage.getItem('npdc_chatbot_sound');
                this.soundSettings.enabled = savedPref !== 'false';

                // Set initial icon state
                if (!this.soundSettings.enabled) {
                    this.soundOnIcon?.classList.add('hidden');
                    this.soundOffIcon?.classList.remove('hidden');
                }

                // Create audio context on first user interaction
                document.addEventListener('click', () => {
                    if (!this.soundSettings.audioContext) {
                        this.soundSettings.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                }, { once: true });
            },

            playNotificationSound() {
                if (!this.soundSettings.enabled || !this.soundSettings.audioContext) return;

                try {
                    const ctx = this.soundSettings.audioContext;
                    const oscillator = ctx.createOscillator();
                    const gainNode = ctx.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);

                    // Pleasant notification tone (two notes)
                    oscillator.frequency.setValueAtTime(587.33, ctx.currentTime); // D5
                    oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.1); // G5

                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(this.soundSettings.volume, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);

                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.3);
                } catch (e) {
                    console.log('Sound notification failed:', e);
                }
            },

            playTipSound() {
                if (!this.soundSettings.enabled || !this.soundSettings.audioContext) return;

                try {
                    const ctx = this.soundSettings.audioContext;
                    const oscillator = ctx.createOscillator();
                    const gainNode = ctx.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);

                    // Gentle attention sound (ascending)
                    oscillator.frequency.setValueAtTime(440, ctx.currentTime); // A4
                    oscillator.frequency.setValueAtTime(523.25, ctx.currentTime + 0.15); // C5
                    oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.3); // E5

                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(this.soundSettings.volume * 0.7, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);

                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.5);
                } catch (e) {
                    console.log('Tip sound failed:', e);
                }
            },

            toggleSound() {
                this.soundSettings.enabled = !this.soundSettings.enabled;
                localStorage.setItem('npdc_chatbot_sound', this.soundSettings.enabled);
                return this.soundSettings.enabled;
            },

            handleSoundToggle() {
                const isEnabled = this.toggleSound();

                // Update UI icons
                if (isEnabled) {
                    this.soundOnIcon.classList.remove('hidden');
                    this.soundOffIcon.classList.add('hidden');
                } else {
                    this.soundOnIcon.classList.add('hidden');
                    this.soundOffIcon.classList.remove('hidden');
                }
            },

            getFieldHelp(fieldId, reason, errorMessage = null) {
                const fieldHelp = {
                    // ===== DATASET IDENTIFICATION =====
                    'metadata_title': {
                        icon: 'üìù',
                        title: 'Need Help with Metadata Title?',
                        message: 'A good dataset title should be descriptive and include the expedition name.',
                        action: 'I am on the Dataset Submission form. How should I write the Metadata Title field? What makes a good dataset title?'
                    },
                    'title': {
                        icon: 'üìù',
                        title: 'Need Help with Title?',
                        message: 'A good dataset title should be descriptive and include the expedition name.',
                        action: 'How should I write the dataset title?'
                    },
                    'abstract': {
                        icon: 'üìÑ',
                        title: 'Writing the Abstract?',
                        message: 'The abstract should summarize your data, methods, and key findings.',
                        action: 'Help me write the abstract'
                    },
                    'keywords': {
                        icon: 'üè∑Ô∏è',
                        title: 'Choosing Keywords?',
                        message: 'Use relevant scientific terms that describe your data.',
                        action: 'What keywords should I use for my dataset?'
                    },
                    'doi': {
                        icon: 'üîó',
                        title: 'DOI Field?',
                        message: 'Digital Object Identifier - leave blank if you don\'t have one yet.',
                        action: 'What is a DOI and do I need one?'
                    },

                    // ===== EXPEDITION & PROJECT =====
                    'expedition_type': {
                        icon: 'üß≠',
                        title: 'Expedition Type?',
                        message: 'Select the expedition that collected this data.',
                        action: 'Explain the different expedition types'
                    },
                    'expedition': {
                        icon: 'üèîÔ∏è',
                        title: 'Which Expedition?',
                        message: 'Select the specific expedition (e.g., 40th Indian Antarctic Expedition).',
                        action: 'How do I find my expedition in the list?'
                    },
                    'project': {
                        icon: 'üìã',
                        title: 'Project Name?',
                        message: 'Enter the research project name under which this data was collected.',
                        action: 'What should I enter for project name?'
                    },
                    'funding_source': {
                        icon: 'üí∞',
                        title: 'Funding Source?',
                        message: 'Enter the organization that funded this research.',
                        action: 'How do I enter funding source details?'
                    },

                    // ===== SPATIAL COVERAGE =====
                    'bounding_box': {
                        icon: 'üó∫Ô∏è',
                        title: 'Spatial Coverage?',
                        message: 'Enter the geographic coordinates where data was collected.',
                        action: 'How do I enter bounding box coordinates?'
                    },
                    'north_bound': {
                        icon: '‚¨ÜÔ∏è',
                        title: 'North Bound?',
                        message: 'Enter the northernmost latitude of your data coverage.',
                        action: 'How do I find the north bound coordinate?'
                    },
                    'south_bound': {
                        icon: '‚¨áÔ∏è',
                        title: 'South Bound?',
                        message: 'Enter the southernmost latitude of your data coverage.',
                        action: 'How do I find the south bound coordinate?'
                    },
                    'east_bound': {
                        icon: '‚û°Ô∏è',
                        title: 'East Bound?',
                        message: 'Enter the easternmost longitude of your data coverage.',
                        action: 'How do I find the east bound coordinate?'
                    },
                    'west_bound': {
                        icon: '‚¨ÖÔ∏è',
                        title: 'West Bound?',
                        message: 'Enter the westernmost longitude of your data coverage.',
                        action: 'How do I find the west bound coordinate?'
                    },
                    'location': {
                        icon: 'üìç',
                        title: 'Location Field?',
                        message: 'Describe where the data was collected (e.g., Maitri Station, Antarctica).',
                        action: 'What should I enter for location?'
                    },

                    // ===== TEMPORAL COVERAGE =====
                    'temporal_coverage': {
                        icon: 'üìÖ',
                        title: 'Date Range?',
                        message: 'Enter when the data was collected.',
                        action: 'How do I specify temporal coverage?'
                    },
                    'start_date': {
                        icon: 'üìÜ',
                        title: 'Start Date?',
                        message: 'Enter when data collection began.',
                        action: 'What format should I use for start date?'
                    },
                    'end_date': {
                        icon: 'üìÜ',
                        title: 'End Date?',
                        message: 'Enter when data collection ended.',
                        action: 'What format should I use for end date?'
                    },

                    // ===== DATA FORMAT & FILES =====
                    'data_format': {
                        icon: 'üìÅ',
                        title: 'Data Format?',
                        message: 'Specify the format of your data files (e.g., CSV, NetCDF, HDF5).',
                        action: 'What data formats are accepted?'
                    },
                    'file_upload': {
                        icon: 'üì§',
                        title: 'File Upload?',
                        message: 'Upload your dataset files here. Supported formats include CSV, NetCDF, etc.',
                        action: 'What files should I upload and what formats are accepted?'
                    },
                    'file': {
                        icon: 'üì§',
                        title: 'Uploading Files?',
                        message: 'Click to select your data files for upload.',
                        action: 'What files should I upload?'
                    },
                    'readme': {
                        icon: 'üìñ',
                        title: 'README File?',
                        message: 'A README explains your data structure and variables.',
                        action: 'What should I include in the README file?'
                    },

                    // ===== ACCESS & LICENSE =====
                    'access_type': {
                        icon: 'üîì',
                        title: 'Access Type?',
                        message: 'Choose who can access your data (Public, Restricted, Private).',
                        action: 'What are the different access types?'
                    },
                    'license': {
                        icon: '‚öñÔ∏è',
                        title: 'License Selection?',
                        message: 'Choose a license for your data (CC-BY recommended for open data).',
                        action: 'Which license should I choose for my data?'
                    },
                    'embargo_date': {
                        icon: 'üîí',
                        title: 'Embargo Date?',
                        message: 'If data should be restricted temporarily, set an embargo end date.',
                        action: 'What is an embargo date and when should I use it?'
                    },

                    // ===== CATEGORY & PARAMETERS =====
                    'category': {
                        icon: 'üìä',
                        title: 'Data Category?',
                        message: 'Select the scientific category (Cryosphere, Atmosphere, Oceans, etc.).',
                        action: 'Explain the data categories'
                    },
                    'parameters': {
                        icon: 'üî¨',
                        title: 'Parameters?',
                        message: 'List the measured variables in your dataset.',
                        action: 'What should I enter for parameters?'
                    },
                    'instrument': {
                        icon: 'üîß',
                        title: 'Instrument Used?',
                        message: 'Enter the instrument/equipment used to collect the data.',
                        action: 'How do I describe the instrument?'
                    },

                    // ===== CONTACT & AUTHOR =====
                    'author': {
                        icon: '‚úçÔ∏è',
                        title: 'Author Name?',
                        message: 'Enter the primary author/creator of this dataset.',
                        action: 'How should I enter author information?'
                    },
                    'contact': {
                        icon: 'üìû',
                        title: 'Contact Info?',
                        message: 'Provide contact details for dataset inquiries.',
                        action: 'What contact information should I provide?'
                    },
                    'affiliation': {
                        icon: 'üèõÔ∏è',
                        title: 'Affiliation?',
                        message: 'Enter your institution or organization name.',
                        action: 'What should I enter for affiliation?'
                    },

                    // ===== SCIENTIST/CITATION FIELDS =====
                    'institute': {
                        icon: 'üèõÔ∏è',
                        title: 'Institute Field',
                        message: 'Enter the full name of your research institute or university (e.g., "National Centre for Polar and Ocean Research").',
                        action: 'What should I enter for institute?'
                    },
                    'online_resource': {
                        icon: 'üåê',
                        title: 'Online Resource URL',
                        message: 'Enter a URL to your organization or project website. This should be a valid web address starting with http:// or https://.',
                        action: 'What URL should I enter for online resource?'
                    },
                    'organisation_url': {
                        icon: 'üîó',
                        title: 'Organisation URL',
                        message: 'Enter the website URL of your organisation (e.g., https://www.ncpor.res.in). Leave blank if not applicable.',
                        action: 'What URL should I enter for my organisation?'
                    },
                    'creator': {
                        icon: '‚úçÔ∏è',
                        title: 'Creator Field',
                        message: 'Enter the name of the person or team who created this dataset.',
                        action: 'Who should I list as the creator?'
                    },
                    'editor': {
                        icon: '‚úèÔ∏è',
                        title: 'Editor Field',
                        message: 'Enter the name of the person who edited or compiled this dataset. Can be left blank.',
                        action: 'Who should I list as the editor?'
                    },
                    'series_name': {
                        icon: 'üìö',
                        title: 'Series Name',
                        message: 'If this dataset is part of a series, enter the series name here.',
                        action: 'What is a series name?'
                    },
                    'release_date': {
                        icon: 'üìÖ',
                        title: 'Release Date',
                        message: 'Enter when this dataset was or will be released/published.',
                        action: 'What date should I enter for release?'
                    },
                    'release_place': {
                        icon: 'üìç',
                        title: 'Release Place',
                        message: 'Enter the city or location where this dataset was released (e.g., "Goa, India").',
                        action: 'What should I enter for release place?'
                    },
                    'phone': {
                        icon: 'üìû',
                        title: 'Phone Number',
                        message: 'Enter a contact phone number with country code (e.g., +91-832-2525515).',
                        action: 'What format should I use for phone number?'
                    },
                    'mobile': {
                        icon: 'üì±',
                        title: 'Mobile Number',
                        message: 'Enter your mobile phone number with country code.',
                        action: 'What format should I use for mobile number?'
                    },
                    'address': {
                        icon: 'üè†',
                        title: 'Address Field',
                        message: 'Enter the complete mailing address of your institution.',
                        action: 'What should I include in the address?'
                    },
                    'city': {
                        icon: 'üèôÔ∏è',
                        title: 'City Field',
                        message: 'Enter the city where your institution is located.',
                        action: 'Which city should I enter?'
                    },
                    'country': {
                        icon: 'üåç',
                        title: 'Country Selection',
                        message: 'Select your country from the dropdown list.',
                        action: 'How do I select my country?'
                    },
                    'state': {
                        icon: 'üó∫Ô∏è',
                        title: 'State/Province',
                        message: 'Select or enter your state/province. Options depend on selected country.',
                        action: 'How do I select my state?'
                    },
                    'postal_code': {
                        icon: 'üìÆ',
                        title: 'Postal Code',
                        message: 'Enter your postal/ZIP code.',
                        action: 'What postal code should I enter?'
                    },
                    'role': {
                        icon: 'üë•',
                        title: 'Role Selection',
                        message: 'Select the role of this person (Principal Investigator, Co-Investigator, Data Manager, etc.).',
                        action: 'What roles are available?'
                    },

                    // ===== LOGIN/REGISTER FIELDS =====
                    'username': {
                        icon: 'üë§',
                        title: 'Username Issues?',
                        message: 'Your username is your registered email address. Use it to log in.',
                        action: 'Help with login issues'
                    },
                    'password': {
                        icon: 'üîê',
                        title: 'Password Requirements',
                        message: 'Password must be at least 8 characters with uppercase, lowercase, number, and special character (@$!%*?&).',
                        action: 'What are the password requirements?'
                    },
                    'email': {
                        icon: 'üìß',
                        title: 'Email Field',
                        message: 'Enter your institutional or work email. This will be used as your login username.',
                        action: 'What email should I use for registration?'
                    },
                    'confirm_email': {
                        icon: 'üìß',
                        title: 'Confirm Email',
                        message: 'Re-enter your email address to verify it is correct.',
                        action: 'Why do I need to confirm my email?'
                    },
                    'confirm_password': {
                        icon: 'üîê',
                        title: 'Confirm Password',
                        message: 'Re-enter your password to make sure it matches.',
                        action: 'Why do I need to confirm my password?'
                    },
                    'first_name': {
                        icon: 'üë§',
                        title: 'First Name',
                        message: 'Enter your first/given name as it appears on official documents.',
                        action: 'What name should I enter?'
                    },
                    'last_name': {
                        icon: 'üë§',
                        title: 'Last Name',
                        message: 'Enter your family/surname as it appears on official documents.',
                        action: 'What name should I enter?'
                    },
                    'organisation': {
                        icon: 'üèõÔ∏è',
                        title: 'Organisation Name',
                        message: 'Enter the full official name of your institution (e.g., "National Centre for Polar and Ocean Research", "Indian Institute of Science").',
                        action: 'What should I enter for organisation name?'
                    },
                    'organisation_url': {
                        icon: 'üîó',
                        title: 'Organisation Website URL',
                        message: 'Enter your organisation\'s official website URL (e.g., https://www.ncpor.res.in). Must start with http:// or https://.',
                        action: 'What URL should I enter for my organisation?'
                    },
                    'designation': {
                        icon: 'üíº',
                        title: 'Designation',
                        message: 'Enter your job title or position (e.g., "Scientist C", "Research Fellow", "Professor", "PhD Scholar").',
                        action: 'What should I enter for designation?'
                    },
                    'profile_url': {
                        icon: 'üîó',
                        title: 'Personal Profile URL',
                        message: 'Link to your profile page on your organisation\'s website. This field is optional.',
                        action: 'What is the personal profile URL?'
                    },
                    'whatsapp_number': {
                        icon: 'üí¨',
                        title: 'WhatsApp Number',
                        message: 'Enter your WhatsApp contact number (optional). Only digits, no country code needed.',
                        action: 'Why do you need my WhatsApp number?'
                    },
                    'alternate_email': {
                        icon: 'üìß',
                        title: 'Alternate Email',
                        message: 'Enter a secondary email address for backup contact (optional).',
                        action: 'Why would I need an alternate email?'
                    },
                    'captcha': {
                        icon: 'üî¢',
                        title: 'Captcha Verification',
                        message: 'Solve the simple math problem shown to verify you are human.',
                        action: 'How do I solve the captcha?'
                    },
                    'reg_title': {
                        icon: 'üëî',
                        title: 'Title Selection',
                        message: 'Select your title: Mr, Ms, Dr, or Prof.',
                        action: 'I am on the Registration form. Which title (Mr, Ms, Dr, Prof) should I select for the Title field?'
                    },
                    'preferred_name': {
                        icon: '‚úèÔ∏è',
                        title: 'Preferred Name',
                        message: 'Enter the name you prefer to be called (optional, can be different from legal name).',
                        action: 'What is preferred name?'
                    }
                };

                // Default help based on reason - include field name for context
                const fieldLabel = fieldId.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').trim();
                const defaultHelp = {
                    'idle': {
                        icon: 'ü§î',
                        title: 'Need Some Help?',
                        message: `You seem to be thinking about the ${fieldLabel} field. I can help!`,
                        action: `Help me understand the ${fieldLabel} field`
                    },
                    'repeated_focus': {
                        icon: 'üí≠',
                        title: `Stuck on ${fieldLabel}?`,
                        message: `I noticed you're having trouble with the ${fieldLabel} field.`,
                        action: `I'm stuck on the ${fieldLabel} field. Help me understand it.`
                    },
                    'validation_error': {
                        icon: '‚ö†Ô∏è',
                        title: 'Validation Error',
                        message: errorMessage ? `Error: "${errorMessage}"` : `Having trouble with the ${fieldLabel} field validation?`,
                        action: errorMessage ? `Fix this error: ${errorMessage}` : `Help me fix the ${fieldLabel} field error`
                    }
                };

                return fieldHelp[fieldId] || defaultHelp[reason] || defaultHelp['idle'];
            },
            initDrag() {
                const header = document.querySelector('.chatbot-header');
                let isDragging = false;
                let startX, startY, initialX, initialY;

                header.style.cursor = 'grab';

                header.addEventListener('mousedown', (e) => {
                    // Don't drag if clicking the close button
                    if (e.target.closest('.chatbot-close')) return;

                    isDragging = true;
                    header.style.cursor = 'grabbing';

                    startX = e.clientX;
                    startY = e.clientY;

                    const rect = this.panel.getBoundingClientRect();
                    initialX = rect.left;
                    initialY = rect.top;

                    // Remove fixed positioning constraints
                    this.panel.style.right = 'auto';
                    this.panel.style.bottom = 'auto';
                    this.panel.style.left = initialX + 'px';
                    this.panel.style.top = initialY + 'px';

                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;

                    let newX = initialX + deltaX;
                    let newY = initialY + deltaY;

                    // Keep within viewport bounds
                    const panelRect = this.panel.getBoundingClientRect();
                    const maxX = window.innerWidth - panelRect.width;
                    const maxY = window.innerHeight - panelRect.height;

                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));

                    this.panel.style.left = newX + 'px';
                    this.panel.style.top = newY + 'px';
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        header.style.cursor = 'grab';
                    }
                });

                // Touch support for mobile
                header.addEventListener('touchstart', (e) => {
                    if (e.target.closest('.chatbot-close')) return;

                    isDragging = true;
                    const touch = e.touches[0];

                    startX = touch.clientX;
                    startY = touch.clientY;

                    const rect = this.panel.getBoundingClientRect();
                    initialX = rect.left;
                    initialY = rect.top;

                    this.panel.style.right = 'auto';
                    this.panel.style.bottom = 'auto';
                    this.panel.style.left = initialX + 'px';
                    this.panel.style.top = initialY + 'px';
                }, { passive: true });

                document.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;

                    const touch = e.touches[0];
                    const deltaX = touch.clientX - startX;
                    const deltaY = touch.clientY - startY;

                    let newX = initialX + deltaX;
                    let newY = initialY + deltaY;

                    const panelRect = this.panel.getBoundingClientRect();
                    const maxX = window.innerWidth - panelRect.width;
                    const maxY = window.innerHeight - panelRect.height;

                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));

                    this.panel.style.left = newX + 'px';
                    this.panel.style.top = newY + 'px';
                }, { passive: true });

                document.addEventListener('touchend', () => {
                    isDragging = false;
                });
            },

            toggleChat() {
                this.isOpen = !this.isOpen;

                if (this.isOpen) {
                    this.panel.style.display = 'flex';
                    this.toggle.style.display = 'none';
                    this.input.focus();
                    this.badge.style.display = 'none';
                    this.closeFAQPopup();

                    // Move progress panel up when chat opens - with smart positioning
                    const progressPanel = document.getElementById('ai-progress-panel');
                    if (progressPanel) {
                        // Get panel height
                        const panelHeight = progressPanel.offsetHeight || 300;
                        const chatHeight = 600; // Chat panel height
                        const spacing = 20; // Spacing between panels
                        const viewportHeight = window.innerHeight;

                        // Calculate safe bottom position
                        // Ensure panel doesn't go above viewport top (with 20px margin)
                        const minBottom = viewportHeight - panelHeight - 20;
                        const desiredBottom = chatHeight + 120; // Chat height + spacing
                        const safeBottom = Math.min(desiredBottom, minBottom);

                        // Apply custom bottom position
                        progressPanel.style.bottom = safeBottom + 'px';
                        progressPanel.classList.add('chat-open');
                    }
                } else {
                    this.panel.style.display = 'none';
                    this.toggle.style.display = 'flex';

                    // Restore progress panel position when chat closes
                    const progressPanel = document.getElementById('ai-progress-panel');
                    if (progressPanel) {
                        progressPanel.style.bottom = ''; // Reset to CSS default
                        progressPanel.classList.remove('chat-open');
                    }
                }
            },

            showFAQPopup() {
                if (this.faqPopup) {
                    this.faqPopup.classList.remove('hidden');
                    this.faqPopup.style.display = 'block';
                }
            },

            closeFAQPopup() {
                if (this.faqPopup) {
                    this.faqPopup.classList.add('hidden');
                    this.faqPopup.style.display = 'none';
                }
            },

            async initializeChat() {
                try {
                    const response = await fetch('/chatbot/api/init/');
                    const data = await response.json();

                    this.addBotMessage(data.greeting);

                    if (data.quick_replies && data.quick_replies.length > 0) {
                        this.showQuickReplies(data.quick_replies);
                    }
                } catch (error) {
                    console.error('Failed to initialize chatbot:', error);
                    this.addBotMessage('Hello! I\'m Penguin, your NPDC assistant. How can I help you?');
                }
            },

            disableInput() {
                this.input.disabled = true;
                this.form.querySelector('button[type="submit"]').disabled = true;
            },

            enableInput() {
                this.input.disabled = false;
                this.form.querySelector('button[type="submit"]').disabled = false;
                this.input.focus();
            },

            async handleSubmit(e) {
                e.preventDefault();

                const message = this.input.value.trim();
                if (!message) return;

                // Prevent sending multiple messages while waiting for response
                if (this.isWaitingForResponse) {
                    return;
                }

                this.isWaitingForResponse = true;
                this.disableInput();
                this.hideQuickReplies(); // Hide quick replies while processing

                // Add user message to history
                this.addToHistory('user', message);
                this.addUserMessage(message);
                this.input.value = '';

                this.showTyping();

                try {
                    const pageInfo = this.getCurrentPageContext();
                    const response = await fetch('/chatbot/api/message/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            page_context: pageInfo.pageContext,
                            page_type: pageInfo.pageType,
                            page_path: pageInfo.pagePath,
                            conversation_history: this.conversationHistory.slice(-10) // Send last 10 messages
                        })
                    });

                    const data = await response.json();

                    this.hideTyping();

                    // Add bot response to history
                    this.addToHistory('assistant', data.message);
                    this.addBotMessage(data.message);

                    if (data.quick_replies && data.quick_replies.length > 0) {
                        this.showQuickReplies(data.quick_replies);
                    } else {
                        this.quickReplies.style.display = 'none';
                    }

                } catch (error) {
                    this.hideTyping();
                    this.addBotMessage('Sorry, I encountered an error. Please try again.');
                    console.error('Chatbot error:', error);
                } finally {
                    this.isWaitingForResponse = false;
                    this.enableInput();
                }
            },

            showTyping() {
                this.typingIndicator.style.display = 'inline-flex';
                this.scrollToBottom();
            },

            hideTyping() {
                this.typingIndicator.style.display = 'none';
            },

            addUserMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message user';
                messageDiv.innerHTML = `
                <div class="message-content">
                    ${this.escapeHtml(text)}
                </div>
            `;
                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            },

            addBotMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message bot';
                const formattedText = text.replace(/\n/g, '<br>');

                messageDiv.innerHTML = `
                <div class="message-content">
                    ${formattedText}
                </div>
            `;

                this.messagesContainer.appendChild(messageDiv);

                const links = messageDiv.querySelectorAll('a');
                links.forEach(link => {
                    link.addEventListener('click', (e) => {
                        if (!link.href.startsWith('http')) {
                            e.preventDefault();
                            window.location.href = link.getAttribute('href');
                        }
                    });
                });

                this.scrollToBottom();

                // Play notification sound for bot response
                this.playNotificationSound();

                if (!this.isOpen) {
                    this.badge.style.display = 'flex';
                }
            },

            showQuickReplies(replies) {
                this.quickReplies.innerHTML = '';

                replies.forEach(reply => {
                    const btn = document.createElement('button');
                    btn.className = 'quick-reply-btn';
                    btn.textContent = reply;
                    btn.addEventListener('click', () => {
                        // Prevent clicking while waiting for response
                        if (this.isWaitingForResponse) return;

                        this.input.value = reply;
                        this.form.dispatchEvent(new Event('submit'));
                    });
                    this.quickReplies.appendChild(btn);
                });

                this.quickReplies.style.display = 'flex';
            },

            hideQuickReplies() {
                this.quickReplies.style.display = 'none';
            },

            // Conversation history management
            addToHistory(role, content) {
                // Strip HTML tags for cleaner history
                const plainText = content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();

                this.conversationHistory.push({
                    role: role,
                    content: plainText
                });

                // Keep only last 10 messages for context
                if (this.conversationHistory.length > 10) {
                    this.conversationHistory = this.conversationHistory.slice(-10);
                }
            },

            clearHistory() {
                this.conversationHistory = [];
            },

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => NPDCChatbot.init());
        } else {
            NPDCChatbot.init();
        }
    })();
</script>